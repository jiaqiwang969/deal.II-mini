<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_50.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-50 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-50 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_16.html">step-16</a>, <a class="el" href="step_37.html">step-37</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Thetestcase">The testcase</a>
        <li><a href="#Workloadimbalanceforgeometricmultigridmethods">Workload imbalance for geometric multigrid methods</a>
        <li><a href="#Workloadimbalanceforalgebraicmultigridmethods">Workload imbalance for algebraic multigrid methods</a>
        <li><a href="#Runningtheprogram">Running the program</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Coefficientsandhelperclasses">Coefficients and helper classes</a>
        <li><a href="#Runtimeparameters">Run time parameters</a>
        <li><a href="#LaplaceProblemclass">LaplaceProblem class</a>
      <ul>
        <li><a href="#LaplaceProblemsetup_system">LaplaceProblem::setup_system()</a>
        <li><a href="#LaplaceProblemsetup_multigrid">LaplaceProblem::setup_multigrid()</a>
        <li><a href="#LaplaceProblemassemble_system">LaplaceProblem::assemble_system()</a>
        <li><a href="#LaplaceProblemassemble_multigrid">LaplaceProblem::assemble_multigrid()</a>
        <li><a href="#LaplaceProblemassemble_rhs">LaplaceProblem::assemble_rhs()</a>
        <li><a href="#LaplaceProblemsolve">LaplaceProblem::solve()</a>
      </ul>
        <li><a href="#Theerrorestimator">The error estimator</a>
      <ul>
        <li><a href="#LaplaceProblemrefine_grid">LaplaceProblem::refine_grid()</a>
        <li><a href="#LaplaceProblemoutput_results">LaplaceProblem::output_results()</a>
        <li><a href="#LaplaceProblemrun">LaplaceProblem::run()</a>
      </ul>
        <li><a href="#Themainfunction">The main() function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions"> Possibilities for extensions </a>
      <ul>
        <li><a href="#Testingconvergenceandhigherorderelements"> Testing convergence and higher order elements </a>
        <li><a href="#Coarsesolver"> Coarse solver </a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 examples/step-50/doc/intro.dox</p>
<p><br />
</p>
<p><em> This program was contributed by Thomas C. Clevenger and Timo Heister. <br />
 This material is based upon work partly supported by the National Science Foundation Award DMS-2028346, OAC-2015848, EAR-1925575, by the Computational Infrastructure in Geodynamics initiative (CIG), through the NSF under Award EAR-0949446 and EAR-1550901 and The University of California &ndash; Davis. </em></p>
<dl class="section note"><dt>Note</dt><dd>If you use this program as a basis for your own work, please consider citing it in your list of references. The initial version of this work was contributed to the deal.II project by the authors listed in the following citation: <a href="https://doi.org/10.5281/zenodo.4004166"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.4004166.svg" alt="10.5281/zenodo.4004166"/></a> </dd>
<dd>
作为这个程序的前提条件，你需要同时安装p4est和PETSc或Trilinos库。在<a href="../../readme.html" target="body">README</a>文件中描述了deal.II和这些附加库的安装情况。</dd></dl>
<p><a class="anchor" id="Intro"></a></p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>这个例子显示了deal.II中的多级函数在并行、分布式网格上的应用，并给出了几何和代数多栅方法的比较。代数多网格(AMG)的前置条件与<a class="el" href="step_40.html">step-40</a>中使用的相同。考虑了两种几何多网格（GMG）预处理方法：一种是类似于步骤16的基于矩阵的版本（但用于并行计算），另一种是步骤37中讨论的无矩阵版本。我们的目标是找出哪种方法能够为大型并行计算提供最佳解算器。</p>
<p>本教程是基于 <b>[clevenger_par_gmg]</b> 中的一个数值例子。关于deal.II中多网格实现的详细背景，请参见该出版物。我们将在下面的文字中总结一些结果。</p>
<p>代数多网格方法显然是最容易用deal.II实现的，因为诸如 <a class="el" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a> 和 <a class="el" href="classPETScWrappers_1_1PreconditionBoomerAMG.html">PETScWrappers::PreconditionBoomerAMG</a> 这样的类本质上是黑盒子预处理程序，即使是并行计算，也只需要几行就能设置好。另一方面，几何多网格方法需要对整个代码库进行修改 &ndash; 不是很多，但必须知道自己在做什么。</p>
<p>这个程序的结果将显示，代数和几何多网格方法的性能大致相当<em>when using matrix-based formulations</em>，而无矩阵的几何多网格方法对于这里所考虑的问题要好很多。另一个结论是，当每个处理器的未知数小于20,000个时，基于矩阵的几何多网格方法真的不能很好地扩展。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>我们考虑变系数拉普拉斯的弱表述</p>
<p class="formulaDsp">
\begin{align*} (\epsilon \nabla u, \nabla v) = (f,v) \quad \forall v \in V_h \end{align*}
</p>
<p>在域 \(\Omega = [-1,1]^\text{dim} \setminus [0,1]^\text{dim}\) （二维的L形域和三维的Fichera角）上，如果 \(\min(x,y,z)&gt;-\frac{1}{2}\) ，则 \(\epsilon = 100\) 。换句话说， \(\epsilon\) 是沿着域的边缘或面跑到重入角的小，这在下图中会看到。</p>
<p>边界条件在整个边界上是 \(u=0\) ，右手边是 \(f=1\) 。我们使用连续 \(Q_2\) 元素来表示离散的有限元空间 \(V_h\) ，并使用基于残差的、单元的后验误差估计器 \(e(K) = e_{\text{cell}}(K) + e_{\text{face}}(K)\) ，来自 <b>[karakashian2003posteriori]</b> 的</p>
<p class="formulaDsp">
\begin{align*} e_{\text{cell}}(K) &amp;= h^2 \| f + \epsilon \triangle u \|_K^2, \\ e_{\text{face}}(K) &amp;= \sum_F h_F \| \jump{ \epsilon \nabla u \cdot n } \|_F^2, \end{align*}
</p>
<p>来适应性地细化网格。(这是KellyErrorEstimator类中使用的Kelly误差估计器的概括，KellyErrorEstimator类驱动大多数其他教程程序中的网格细化。)下图显示了二维的求解和细化： </p><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-50-2d-solution.png" width="400px"/>
</div>
<p> 在三维中，求解看起来类似（见下文）。在左边你可以看到解决方案，在右边我们显示了靠近域中心的 \(x\) 的切片，显示了自适应细化的网格。 </p><table width="60%" align="center">
<tr>
<td align="center"><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-50-3d-solution.png" width="400px"/>
</div>
  </td><td align="center"><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-50-refinement.png" width="400px"/>
</div>
   </td></tr>
</table>
<p>在二维和三维中，你都可以看到自适应细化拾取了角部奇点和粘度跳跃的内部奇点，而沿分离两个粘度的线的界面（正确地）没有被细化，因为它被充分地解决。这是因为由系数跳跃导致的解决方案中的扭结与细胞界面对齐。</p>
<p><a class="anchor" id="Workloadimbalanceforgeometricmultigridmethods"></a></p><h3>Workload imbalance for geometric multigrid methods</h3>
<p>如上所述，这个程序的目的是展示代数和几何多网格方法在这个问题上的应用，并做到并行计算。使算法扩展到大型并行机器的一个重要组成部分是确保每个处理器都有相同的工作量。更准确地说，重要的是没有一小部分处理器比其他处理器有更多的工作，因为如果是这样的话，很大一部分处理器会闲置，等待小部分处理器完成。相反，一小部分处理器的工作大大超过<em>less</em>并不是问题，因为大多数处理器继续生产，只有一小部分处理器在完成工作后闲置。)</p>
<p>对于活跃的网格，我们使用 <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> 类，正如在步骤40中所做的那样，它使用外部库<a href="http://www.p4est.org/">p4est</a>中的功能在处理器之间分配活跃单元。对于多级层次结构中的非活动单元，deal.II实现了我们所说的 "第一子规则"，对于层次结构中的每个单元，我们递归地将一个单元的父级分配给第一个子单元的所有者。下面的数字给出了这样一个分布的例子。这里的左图表示使用空间填充曲线划分的二维网格样本的活动单元（这也是p4est用来划分单元的方法）；中间的图片给出了活动网格的树状表示；右图给出了单元的多级层次结构。颜色和数字代表不同的处理器。树上的圆形节点是非活动单元，使用 "长子规则 "进行分配。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-50-workload-example.png" width="800px"/>
</div>
<p>在这个例子中，屏幕上的输出包括一个 "分区效率 "的值，这个值由 <a class="el" href="namespaceMGTools.html#a8776ac550d9ac85e7e0db51625935673">MGTools::workload_imbalance()</a>. 给出，将用 \(\mathbb{E}\) 表示，量化了多网格层次结构中每一层没有完美的工作平衡所产生的开销。这种不平衡在上面的例子中很明显：虽然 \(\ell=2\) 层在三个处理器的四个单元中尽可能的平衡，但粗略的 \(\ell=0\) 层只有一个处理器有工作，而 \(\ell=1\) 层只有两个处理器有工作，其中一个处理器的工作是另一个的三倍。</p>
<p>对于定义 \(\mathbb{E}\) ，需要注意的是，由于我们使用局部平滑来定义多网格层次（参见 <a class="el" href="DEALGlossary.html#mg_paper">多网格论文 </a>中对局部平滑的描述），一个单元的细化水平对应于该单元的多网格水平。现在，让 \(N_{\ell}\) 为 \(\ell\) 层的单元数（包括活动和非活动单元）， \(N_{\ell,p}\) 为进程 \(p\) 所拥有的子集。我们还将用 \(P\) 表示处理器的总数量。假设任何一个处理器的工作量与该处理器拥有的单元格数量成正比，每个处理器的最佳工作量为</p>
<p class="formulaDsp">
\begin{align*} W_{\text{opt}} = \frac1{P}\sum_{\ell} N_{\ell} = \sum_{\ell}\left(\frac1{P}\sum_{p}N_{\ell,p}\right). \end{align*}
</p>
<p>接下来，假设每一层的工作都是同步的（即在V型循环的每一层，在进入下一层之前，所有的处理器都必须完成工作），每一层的极限工作由以下公式给出</p>
<p class="formulaDsp">
\begin{align*} W_\ell = \max_{p} N_{\ell,p}, \end{align*}
</p>
<p>和总的并行复杂性</p>
<p class="formulaDsp">
\begin{align*} W = \sum_{\ell} W_\ell. \end{align*}
</p>
<p>然后我们将 \(\mathbb{E}\) 定义为最佳分区与当前分区的并行复杂度之比</p>
<p class="formulaDsp">
\begin{align*} \mathbb{E} = \frac{W_{\text{opt}}}{W}. \end{align*}
</p>
<p>对于上面的例子分布，我们有</p>
<p class="formulaDsp">
\begin{align*} W_{\text{opt}}&amp;=\frac{1}{P}\sum_{\ell} N_{\ell} = \frac{1}{3} \left(1+4+4\right)= 3 \qquad \\ W &amp;= \sum_\ell W_\ell = 1 + 2 + 3 = 6 \\ \mathbb{E} &amp;= \frac{W_{\text{opt}}}{W} = \frac12. \end{align*}
</p>
<p>这个值 <a class="el" href="namespaceMGTools.html#a8776ac550d9ac85e7e0db51625935673">MGTools::workload_imbalance()</a> \(= 1/\mathbb{E}\) 代表了我们对GMG方法（vmults、assembly等）所期望的时间增加的因素，因为与完全负载平衡的工作负载相比，网格分区的不平衡。我们将在下面的结果部分报告一连串的网格，并与观察到的减速进行比较，因为我们的处理器数量越来越大（通常，负载不平衡也会变大）。</p>
<p>这些考虑在 <b>[clevenger_par_gmg]</b> 中得到了更详细的考虑，其中包含了对分区效率模型和不平衡对GMG V周期时间的影响的全面讨论。总之， \(\mathbb{E}\) 的值高度依赖于所使用的局部网格细化程度，对于全局细化的网格有一个最佳值 \(\mathbb{E} \approx 1\) 。通常对于自适应细化的网格，用于分配单个网格的处理器数量对 \(\mathbb{E}\) 有负面影响，但只到一个平移点，即处理器数量增加时，不平衡度保持相对稳定，进一步细化对 \(\mathbb{E}\) 的影响很小。最后， \(1/\mathbb{E}\) 被证明可以准确地表示出对V型周期的计时所预期的并行扩展的减慢。</p>
<p>应该注意的是，在多级网格之间有可能存在一些异步工作，特别是纯粹的近邻MPI通信，而且可以构建一个自适应网格，由于异步工作 "掩盖 "了不平衡，效率模型将远远高估V-周期的减慢（假设各级同步）。然而，对于大多数现实的自适应网格来说，预期这种异步工作只会掩盖非常小的一部分不平衡，效率模型会很好地描述减速。</p>
<p><a class="anchor" id="Workloadimbalanceforalgebraicmultigridmethods"></a></p><h3>Workload imbalance for algebraic multigrid methods</h3>
<p>上面的考虑表明，我们必须期待在deal.II中实现的几何多网格算法的可扩展性有一定的限制，因为即使在网格的最细层是完全负载平衡的情况下，较粗层也可能不是。同时，较粗层的权重较小（ \(W_\ell\) 对 \(W\) 的贡献较小），因为较粗层的单元较少，因此，对整体运行时间的贡献不如较细层。换句话说，较粗层次的不平衡可能不会导致大局的影响。</p>
<p>代数多网格方法当然是基于一种完全不同的方法来创建层次结构的。特别是，他们纯粹是在分析系统矩阵的基础上创建这些层次，并且在作为 <a class="el" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a> 和 <a class="el" href="classPETScWrappers_1_1PreconditionBoomerAMG.html">PETScWrappers::PreconditionBoomerAMG</a> 类基础的hypre和ML/MueLu包中都实现了非常复杂的算法，以确保问题在每个层次上都得到良好的负载平衡。在某种意义上，这些算法比几何多网格方法更简单，因为它们只处理矩阵本身，而不是所有的网格、邻居、父母和其他几何实体的内涵。同时，为了使代数多网格方法能够扩展到非常大的问题，人们也做了很多工作，包括将在某一层次上工作的处理器数量减少到所有处理器的一个子集，如果不这样的话，处理器花在计算上的时间会比花在通信上的时间少。(人们可能会注意到，在几何多网格算法中也有可能实现这些相同的想法，在这些算法中，人们有目的地将一些处理器闲置在较粗的层次上，以减少通信量。只是目前deal.II没有这样做。)</p>
<p>然而，这些并不是我们在这里通常需要担心的问题。在大多数情况下，我们使用代数多网格方法作为黑箱方法。</p>
<p><a class="anchor" id="Runningtheprogram"></a></p><h3>Running the program</h3>
<p>如上所述，这个程序可以使用三种不同的方式来求解线性系统：基于矩阵的几何多网格（"MB"），无矩阵几何多网格（"MF"）和代数多网格（"AMG"）。这个程序所在的目录有后缀为".prm "的输入文件，适用于所有这三种选项，以及2D和3D。</p>
<p>你可以按以下方式执行该程序</p>
<div class="fragment"><div class="line">./step-50 gmg_mb_2d.prm</div></div><!-- fragment --><p>而这将从给定的输入文件（这里是<code>mg_mb_2d.prm</code>）中获取运行时参数。</p>
<p>该程序的目的是要并行运行，你可以使用诸如以下的命令来实现这一点</p>
<div class="fragment"><div class="line">mpirun -np 4 ./step-50 gmg_mb_2d.prm</div></div><!-- fragment --><p>如果你想，比如说，在四个处理器上运行。也就是说，如果你有多少个处理器，程序也可以在<code>-np 28672</code>下运行）。</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>包含文件是 <a class="el" href="step_40.html">step-40</a> , <a class="el" href="step_16.html">step-16</a> , 和 <a class="el" href="step_37.html">step-37</a> 的组合。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__base_8h.html">deal.II/base/data_out_base.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span> </div></div><!-- fragment --><p>我们使用与 <a class="el" href="step_40.html">step-40</a> 相同的策略，在PETSc和Trilinos之间进行切换。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span> </div></div><!-- fragment --><p>如果你已经安装了PETSc和Trilinos，并且你喜欢在本例中使用PETSc，请将下面的预处理程序定义注释进去或退出。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define FORCE_USE_OF_TRILINOS </span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA </div><div class="line">{ </div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \ </span></div><div class="line">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS)) </div><div class="line">  <span class="keyword">using</span> <span class="keyword">namespace</span> dealii::LinearAlgebraPETSc; </div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA </span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS) </span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos; </div><div class="line"><span class="preprocessor">#else </span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required </span></div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">} <span class="comment">// namespace LA </span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_8h.html">deal.II/matrix_free/matrix_free.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="operators_8h.html">deal.II/matrix_free/operators.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__evaluation_8h.html">deal.II/matrix_free/fe_evaluation.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__coarse_8h.html">deal.II/multigrid/mg_coarse.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__constrained__dofs_8h.html">deal.II/multigrid/mg_constrained_dofs.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__matrix_8h.html">deal.II/multigrid/mg_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__smoother_8h.html">deal.II/multigrid/mg_smoother.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__tools_8h.html">deal.II/multigrid/mg_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer_8h.html">deal.II/multigrid/mg_transfer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="multigrid_8h.html">deal.II/multigrid/multigrid.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer__matrix__free_8h.html">deal.II/multigrid/mg_transfer_matrix_free.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span> </div></div><!-- fragment --><p>以下文件用于组装误差估计器，如 <a class="el" href="step_12.html">step-12</a> 。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__interface__values_8h.html">deal.II/fe/fe_interface_values.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mesh__loop_8h.html">deal.II/meshworker/mesh_loop.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div></div><!-- fragment --><p><a class="anchor" id="Coefficientsandhelperclasses"></a> </p><h3>Coefficients and helper classes</h3>
<p>MatrixFree运算符必须使用 <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a> 矢量类型。这里我们定义了复制到Trilinos向量的操作，以便与基于矩阵的代码兼容。请注意，目前PETSc矢量类型不存在这种功能，所以必须安装Trilinos来使用本教程中的MatrixFree求解器。</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>ChangeVectorTypes </div><div class="line">{ </div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">copy</a>(<a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a> &amp;                                         out, </div><div class="line">            const ::LinearAlgebra::distributed::Vector&lt;number&gt; &amp;in) </div><div class="line">  { </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">::LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rwv( </div><div class="line">      out.locally_owned_elements()); </div><div class="line">    rwv.<a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html#a01a417b8d7b2c5858f49cdc4c663779f">import</a>(in, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, </div><div class="line">                <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;CopyVectorTypes::copy() not implemented for &quot;</span> </div><div class="line">                           <span class="stringliteral">&quot;PETSc vector types.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">    out.import(rwv, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">copy</a>(::<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;number&gt;</a> &amp;out, </div><div class="line">            <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a> &amp;                             in) </div><div class="line">  { </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">::LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rwv; </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">    (void)in; </div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, </div><div class="line">                <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;CopyVectorTypes::copy() not implemented for &quot;</span> </div><div class="line">                           <span class="stringliteral">&quot;PETSc vector types.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">    rwv.<a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html#aaee2ea7c671f9ece558b081b0d104295">reinit</a>(in); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">    out.<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html#af7b743d761233b92e0ed23e6bf37a409">import</a>(rwv, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line">  } </div><div class="line">} <span class="comment">// namespace ChangeVectorTypes </span></div></div><!-- fragment --><p>让我们继续描述我们要解决的问题。我们把右边的函数设置为1.0。 <code>value</code> 函数返回一个VectorizedArray，被无矩阵代码路径所使用。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt; </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const override </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <span class="keywordflow">return</span> 1.0; </div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> </div><div class="line">  <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp; <span class="comment">/*p*/</span>, </div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>(1.0); </div><div class="line">  } </div><div class="line">}; </div></div><!-- fragment --><p>接下来的这个类表示扩散系数。我们使用一个可变的系数，在任何一个至少有一个坐标小于-0.5的点上是100.0，在所有其他点上是1.0。如上所述，一个单独的value()返回一个VectorizedArray，用于无矩阵代码。一个 <code>average()函数计算了一组点的算术平均。</code> </p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt; </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0) <span class="keyword">const override</span>; </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;p, </div><div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0) <span class="keyword">const</span>; </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  number average_value(<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim, number&gt;</a>&gt; &amp;points) <span class="keyword">const</span>; </div></div><!-- fragment --><p>当在MatrixFree框架中使用一个系数时，我们还需要一个函数，为MatrixFree运算符参数提供的一组单元格创建一个系数表。</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  std::shared_ptr&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt; make_coefficient_table( </div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree</a>&lt;dim, number, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;mf_storage) <span class="keyword">const</span>; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">if</span> (p[d] &lt; -0.5) </div><div class="line">        <span class="keywordflow">return</span> 100.0; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">return</span> 1.0; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line"><a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> </div><div class="line">Coefficient&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;p, </div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> return_value = <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>(1.0); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; VectorizedArray&lt;number&gt;::size(); ++i) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>) </div><div class="line">        <span class="keywordflow">if</span> (p[d][i] &lt; -0.5) </div><div class="line">          { </div><div class="line">            return_value[i] = 100.0; </div><div class="line">            <span class="keywordflow">break</span>; </div><div class="line">          } </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> return_value; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">number Coefficient&lt;dim&gt;::average_value( </div><div class="line">  <span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim, number&gt;</a>&gt; &amp;points)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  number average(0); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; points.size(); ++i) </div><div class="line">    average += value(points[i]); </div><div class="line">  average /= points.size(); </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> average; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">std::shared_ptr&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt; </div><div class="line">Coefficient&lt;dim&gt;::make_coefficient_table( </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree</a>&lt;dim, number, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;mf_storage)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <span class="keyword">auto</span> coefficient_table = </div><div class="line">    std::make_shared&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt;(); </div><div class="line"></div><div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation</a>&lt;dim, -1, 0, 1, number&gt; fe_eval(mf_storage); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cells    = mf_storage.n_cell_batches(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = fe_eval.n_q_points; </div><div class="line"></div><div class="line">  coefficient_table-&gt;reinit(n_cells, 1); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; cell &lt; <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>; ++cell) </div><div class="line">    { </div><div class="line">      fe_eval.reinit(cell); </div><div class="line"></div><div class="line">      <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> average_value = 0.; </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q) </div><div class="line">        average_value += value(fe_eval.quadrature_point(q)); </div><div class="line">      average_value /= n_q_points; </div><div class="line"></div><div class="line">      (*coefficient_table)(cell, 0) = average_value; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> coefficient_table; </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="Runtimeparameters"></a> </p><h3>Run time parameters</h3>
<p>我们将使用ParameterHandler来在运行时传入参数。 该结构 <code>Settings</code> 解析并存储这些参数，以便在整个程序中进行查询。</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> </div><div class="line">{ </div><div class="line">  <span class="keywordtype">bool</span> try_parse(<span class="keyword">const</span> std::string &amp;prm_filename); </div><div class="line"></div><div class="line">  <span class="keyword">enum</span> <a class="code" href="classSolverType.html">SolverType</a> </div><div class="line">  { </div><div class="line">    gmg_mb, </div><div class="line">    gmg_mf, </div><div class="line">    amg </div><div class="line">  }; </div><div class="line"></div><div class="line">  <a class="code" href="classSolverType.html">SolverType</a> solver; </div><div class="line"></div><div class="line">  <span class="keywordtype">int</span>          dimension; </div><div class="line">  <span class="keywordtype">double</span>       smoother_dampen; </div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> smoother_steps; </div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_steps; </div><div class="line">  <span class="keywordtype">bool</span>         output; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> Settings::try_parse(<span class="keyword">const</span> std::string &amp;prm_filename) </div><div class="line">{ </div><div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm; </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;dim&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(), <span class="stringliteral">&quot;The problem dimension.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;n_steps&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;10&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0), </div><div class="line">                    <span class="stringliteral">&quot;Number of adaptive refinement steps.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;smoother dampen&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;1.0&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), </div><div class="line">                    <span class="stringliteral">&quot;Dampen factor for the smoother.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;smoother steps&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;1&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1), </div><div class="line">                    <span class="stringliteral">&quot;Number of smoother steps.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;solver&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;MF&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Selection.html">Patterns::Selection</a>(<span class="stringliteral">&quot;MF|MB|AMG&quot;</span>), </div><div class="line">                    <span class="stringliteral">&quot;Switch between matrix-free GMG, &quot;</span> </div><div class="line">                    <span class="stringliteral">&quot;matrix-based GMG, and AMG.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;output&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;false&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(), </div><div class="line">                    <span class="stringliteral">&quot;Output graphical results.&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (prm_filename.size() == 0) </div><div class="line">    { </div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;****  Error: No input file provided!\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  Error: Call this program as &#39;./step-50 input.prm\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  You may want to use one of the input files in this\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  directory, or use the following default values\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  to create an input file:\n&quot;</span>; </div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0) </div><div class="line">        prm.<a class="code" href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">print_parameters</a>(std::cout, <a class="code" href="classParameterHandler.html#a8364dda711b93753c6809eefe2a8e827ae4d13a4598073bfcb69cd0cf4c1f8365">ParameterHandler::Text</a>); </div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      prm.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(prm_filename); </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;e) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0) </div><div class="line">        std::cerr &lt;&lt; e.what() &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;MF&quot;</span>) </div><div class="line">    this-&gt;solver = gmg_mf; </div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;MB&quot;</span>) </div><div class="line">    this-&gt;solver = gmg_mb; </div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;AMG&quot;</span>) </div><div class="line">    this-&gt;solver = amg; </div><div class="line">  <span class="keywordflow">else</span> </div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line"></div><div class="line">  this-&gt;dimension       = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;dim&quot;</span>); </div><div class="line">  this-&gt;n_steps         = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;n_steps&quot;</span>); </div><div class="line">  this-&gt;smoother_dampen = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;smoother dampen&quot;</span>); </div><div class="line">  this-&gt;smoother_steps  = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;smoother steps&quot;</span>); </div><div class="line">  this-&gt;output          = prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;output&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>; </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemclass"></a> </p><h3>LaplaceProblem class</h3>
<p>这是该程序的主类。它看起来与 <a class="el" href="step_16.html">step-16</a> , <a class="el" href="step_37.html">step-37</a> , 和 <a class="el" href="step_40.html">step-40</a> 非常相似。对于MatrixFree的设置，我们使用 <a class="el" href="classMatrixFreeOperators_1_1LaplaceOperator.html">MatrixFreeOperators::LaplaceOperator</a> 类，它在内部定义了<code>local_apply()</code>, <code><a class="el" href="namespaceMatrixFreeTools.html#a523190adf5671e317d745fed4b1d357f">compute_diagonal()</a></code>, 和<code>set_coefficient()</code>函数。请注意，多项式的度数是这个类的一个模板参数。这对无矩阵代码来说是必要的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keyword">class </span>LaplaceProblem </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  LaplaceProblem(<span class="keyword">const</span> <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> &amp;settings); </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>(); </div><div class="line"></div><div class="line"><span class="keyword">private</span>: </div></div><!-- fragment --><p>我们将在整个程序中使用以下类型。首先是基于矩阵的类型，之后是无矩阵的类。对于无矩阵的实现，我们使用 <code>float</code> 作为水平运算符。</p>
<div class="fragment"><div class="line">  <span class="keyword">using</span> MatrixType         = <a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>; </div><div class="line">  <span class="keyword">using</span> <a class="code" href="classVectorType.html">VectorType</a>         = <a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a>; </div><div class="line">  <span class="keyword">using</span> <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">PreconditionAMG</a>    = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>; </div><div class="line">  <span class="keyword">using</span> <a class="code" href="classPreconditionJacobi.html">PreconditionJacobi</a> = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a84fd288bacabd1a7e3408885fb0fad01">LA::MPI::PreconditionJacobi</a>; </div><div class="line"></div><div class="line">  <span class="keyword">using</span> MatrixFreeLevelMatrix = <a class="code" href="classMatrixFreeOperators_1_1LaplaceOperator.html">MatrixFreeOperators::LaplaceOperator</a>&lt; </div><div class="line">    dim, </div><div class="line">    degree, </div><div class="line">    degree + 1, </div><div class="line">    1, </div><div class="line">    LinearAlgebra::distributed::Vector&lt;float&gt;&gt;; </div><div class="line">  <span class="keyword">using</span> MatrixFreeActiveMatrix = <a class="code" href="classMatrixFreeOperators_1_1LaplaceOperator.html">MatrixFreeOperators::LaplaceOperator</a>&lt; </div><div class="line">    dim, </div><div class="line">    degree, </div><div class="line">    degree + 1, </div><div class="line">    1, </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a>&gt;; </div><div class="line"></div><div class="line">  <span class="keyword">using</span> MatrixFreeLevelVector  = LinearAlgebra::distributed::Vector&lt;float&gt;; </div><div class="line">  <span class="keyword">using</span> MatrixFreeActiveVector = LinearAlgebra::distributed::Vector&lt;double&gt;; </div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> setup_system(); </div><div class="line">  <span class="keywordtype">void</span> setup_multigrid(); </div><div class="line">  <span class="keywordtype">void</span> assemble_system(); </div><div class="line">  <span class="keywordtype">void</span> assemble_multigrid(); </div><div class="line">  <span class="keywordtype">void</span> assemble_rhs(); </div><div class="line">  <span class="keywordtype">void</span> solve(); </div><div class="line">  <span class="keywordtype">void</span> estimate(); </div><div class="line">  <span class="keywordtype">void</span> refine_grid(); </div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> settings; </div><div class="line"></div><div class="line">  <a class="code" href="classMPI__Comm.html">MPI_Comm</a>           mpi_communicator; </div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout; </div><div class="line"></div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>; </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                                 fe; </div><div class="line"></div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler; </div><div class="line"></div><div class="line"> </div><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a>                  locally_relevant_dofs; </div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints; </div><div class="line"></div><div class="line">  MatrixType             system_matrix; </div><div class="line">  MatrixFreeActiveMatrix mf_system_matrix; </div><div class="line">  <a class="code" href="classVectorType.html">VectorType</a>             solution; </div><div class="line">  <a class="code" href="classVectorType.html">VectorType</a>             right_hand_side; </div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>         estimated_error_square_per_cell; </div><div class="line"></div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixType&gt;</a> mg_matrix; </div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixType&gt;</a> mg_interface_in; </div><div class="line">  <a class="code" href="classMGConstrainedDoFs.html">MGConstrainedDoFs</a>         mg_constrained_dofs; </div><div class="line"></div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixFreeLevelMatrix&gt;</a> mf_mg_matrix; </div><div class="line"></div><div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a> computing_timer; </div><div class="line">}; </div></div><!-- fragment --><p>关于构造函数的唯一有趣的部分是，除非我们使用AMG，否则我们会构造多网格的层次结构。为此，我们需要在这个构造函数完成之前解析运行时参数。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line">LaplaceProblem&lt;dim, degree&gt;::LaplaceProblem(<span class="keyword">const</span> <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> &amp;settings) </div><div class="line">  : settings(settings) </div><div class="line">  , mpi_communicator(MPI_COMM_WORLD) </div><div class="line">  , pcout(<a class="code" href="namespacestd.html">std</a>::cout, (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)) </div><div class="line">  , triangulation(mpi_communicator, </div><div class="line">                  <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::limit_level_difference_at_vertices, </div><div class="line">                  (settings.solver == <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a>::amg) ? </div><div class="line">                    <a class="code" href="namespaceparallel.html">parallel</a>::distributed::<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::<a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0a7c2ea84f1b4c5f2a6aa010f600ca66b6">default_setting</a> : </div><div class="line">                    <a class="code" href="namespaceparallel.html">parallel</a>::distributed::<a class="code" href="classTriangulation.html">Triangulation</a>&lt; </div><div class="line">                      dim&gt;::<a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0acc0ed1c2dd30bca7c7576e65b4045274">construct_multigrid_hierarchy</a>) </div><div class="line">  , mapping() </div><div class="line">  , fe(degree) </div><div class="line">  , dof_handler(triangulation) </div><div class="line">  , computing_timer(pcout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::never, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times) </div><div class="line">{ </div><div class="line">  <a class="code" href="namespaceGridGenerator.html#a3b2a4ad8296c2b72a11d23b5969e8cc0">GridGenerator::hyper_L</a>(triangulation, -1., 1., <span class="comment">/*colorize*/</span> <span class="keyword">false</span>); </div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(1); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemsetup_system"></a> </p><h4>LaplaceProblem::setup_system()</h4>
<p>与 <a class="el" href="step_16.html">step-16</a> 和 <a class="el" href="step_37.html">step-37</a> 不同，我们将设置分成两部分，setup_system() 和 setup_multigrid() 。下面是大多数教程中常见的主动网格的典型setup_system()函数。对于无矩阵，活动网格的设置类似于 <a class="el" href="step_37.html">step-37</a> ；对于基于矩阵（GMG和AMG求解器），设置类似于 <a class="el" href="step_40.html">step-40</a> 。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::setup_system() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Setup&quot;</span>); </div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs); </div><div class="line">  locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(); </div><div class="line"></div><div class="line">  solution.reinit(locally_owned_dofs, mpi_communicator); </div><div class="line">  right_hand_side.reinit(locally_owned_dofs, mpi_communicator); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(locally_relevant_dofs); </div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>( </div><div class="line">    mapping, dof_handler, 0, <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(), constraints); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span> (settings.solver) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">        { </div><div class="line">          <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim, double&gt;::AdditionalData</a> additional_data; </div><div class="line">          additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> = </div><div class="line">            <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;::AdditionalData::none</a>; </div><div class="line">          additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#aa5d597e6c4441d273f4100b6139a2552">mapping_update_flags</a> = </div><div class="line">            (<a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>); </div><div class="line">          std::shared_ptr&lt;MatrixFree&lt;dim, double&gt;&gt; mf_storage = </div><div class="line">            std::make_shared&lt;MatrixFree&lt;dim, double&gt;&gt;(); </div><div class="line">          mf_storage-&gt;reinit(mapping, </div><div class="line">                             dof_handler, </div><div class="line">                             constraints, </div><div class="line">                             <a class="code" href="classQGauss.html">QGauss&lt;1&gt;</a>(degree + 1), </div><div class="line">                             additional_data); </div><div class="line"></div><div class="line">          mf_system_matrix.initialize(mf_storage); </div><div class="line"></div><div class="line">          <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">          mf_system_matrix.set_coefficient( </div><div class="line">            coefficient.make_coefficient_table(*mf_storage)); </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">      <span class="keywordflow">case</span> Settings::amg: </div><div class="line">        { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(locally_relevant_dofs); </div><div class="line">          <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, constraints); </div><div class="line"></div><div class="line">          <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(dsp, </div><div class="line">                                                     locally_owned_dofs, </div><div class="line">                                                     mpi_communicator, </div><div class="line">                                                     locally_relevant_dofs); </div><div class="line"></div><div class="line">          system_matrix.reinit(locally_owned_dofs, </div><div class="line">                               locally_owned_dofs, </div><div class="line">                               dsp, </div><div class="line">                               mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp(locally_owned_dofs, </div><div class="line">                                                locally_owned_dofs, </div><div class="line">                                                locally_relevant_dofs, </div><div class="line">                                                mpi_communicator); </div><div class="line">          <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, constraints); </div><div class="line">          dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">          system_matrix.reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemsetup_multigrid"></a> </p><h4>LaplaceProblem::setup_multigrid()</h4>
<p>该函数为无矩阵和基于矩阵的GMG进行多级设置。无矩阵的设置类似于 <a class="el" href="step_37.html">step-37</a> ，而基于矩阵的设置类似于 <a class="el" href="step_16.html">step-16</a> ，只是我们必须使用适当的分布式稀疏度模式。</p>
<p>该函数没有被AMG方法调用，但为了安全起见，该函数的主<code>switch</code>语句还是确保了该函数只在已知的多网格设置下运行，如果该函数被调用到两种几何多网格方法以外的地方，则抛出一个断言。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::setup_multigrid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Setup multigrid&quot;</span>); </div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a9aed31323cbd7619edac310c47e7a7ad">distribute_mg_dofs</a>(); </div><div class="line"></div><div class="line">  mg_constrained_dofs.clear(); </div><div class="line">  mg_constrained_dofs.initialize(dof_handler); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::set&lt;types::boundary_id&gt; boundary_ids = {<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>(0)}; </div><div class="line">  mg_constrained_dofs.make_zero_boundary_constraints(dof_handler, boundary_ids); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_levels = triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span> (settings.solver) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">        { </div><div class="line">          mf_mg_matrix.resize(0, n_levels - 1); </div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            { </div><div class="line">              <a class="code" href="classIndexSet.html">IndexSet</a> relevant_dofs; </div><div class="line">              <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                            level, </div><div class="line">                                                            relevant_dofs); </div><div class="line">              <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> level_constraints; </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(relevant_dofs); </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#aef97b22281acb10c914d79a3881e2735">add_lines</a>( </div><div class="line">                mg_constrained_dofs.get_boundary_indices(level)); </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line"></div><div class="line">              <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim, float&gt;::AdditionalData</a> additional_data; </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> = </div><div class="line">                <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, float&gt;::AdditionalData::none</a>; </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#aa5d597e6c4441d273f4100b6139a2552">mapping_update_flags</a> = </div><div class="line">                (<a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | </div><div class="line">                 <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>); </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a67c9ff01c51fb7fb3ada151b83cdd409">mg_level</a> = <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>; </div><div class="line">              std::shared_ptr&lt;MatrixFree&lt;dim, float&gt;&gt; mf_storage_level( </div><div class="line">                <span class="keyword">new</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, float&gt;</a>()); </div><div class="line">              mf_storage_level-&gt;reinit(mapping, </div><div class="line">                                       dof_handler, </div><div class="line">                                       level_constraints, </div><div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;1&gt;</a>(degree + 1), </div><div class="line">                                       additional_data); </div><div class="line"></div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].initialize(mf_storage_level, </div><div class="line">                                             mg_constrained_dofs, </div><div class="line">                                             level); </div><div class="line"></div><div class="line">              <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].set_coefficient( </div><div class="line">                coefficient.make_coefficient_table(*mf_storage_level)); </div><div class="line"></div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].compute_diagonal(); </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">        { </div><div class="line">          mg_matrix.resize(0, n_levels - 1); </div><div class="line">          mg_matrix.clear_elements(); </div><div class="line">          mg_interface_in.resize(0, n_levels - 1); </div><div class="line">          mg_interface_in.clear_elements(); </div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            { </div><div class="line">              <a class="code" href="classIndexSet.html">IndexSet</a> dof_set; </div><div class="line">              <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                            level, </div><div class="line">                                                            dof_set); </div><div class="line"></div><div class="line">              { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">                <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_set); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>( </div><div class="line">                  dsp, </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  mpi_communicator, </div><div class="line">                  dof_set); </div><div class="line"></div><div class="line">                mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dsp, </div><div class="line">                  mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">                <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_set, </div><div class="line">                  mpi_communicator); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line"></div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">              } </div><div class="line"></div><div class="line">              { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">                <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_set); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a8c677f65f8f1d21fb1f4c55cb90079e0">MGTools::make_interface_sparsity_pattern</a>(dof_handler, </div><div class="line">                                                         mg_constrained_dofs, </div><div class="line">                                                         dsp, </div><div class="line">                                                         level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>( </div><div class="line">                  dsp, </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  mpi_communicator, </div><div class="line">                  dof_set); </div><div class="line"></div><div class="line">                mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dsp, </div><div class="line">                  mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">                <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_set, </div><div class="line">                  mpi_communicator); </div><div class="line"></div><div class="line">                <a class="code" href="namespaceMGTools.html#a8c677f65f8f1d21fb1f4c55cb90079e0">MGTools::make_interface_sparsity_pattern</a>(dof_handler, </div><div class="line">                                                         mg_constrained_dofs, </div><div class="line">                                                         dsp, </div><div class="line">                                                         level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">              } </div><div class="line">            } </div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemassemble_system"></a> </p><h4>LaplaceProblem::assemble_system()</h4>
<p>汇编被分成三个部分：<code>assemble_system()</code>, <code>assemble_multigrid()</code>, 和<code>assemble_rhs()</code>。这里的<code>assemble_system()</code>函数组装并存储（全局）系统矩阵和基于矩阵的方法的右手边。它类似于 <a class="el" href="step_40.html">step-40</a> 中的装配。</p>
<p>注意，无矩阵方法不执行这个函数，因为它不需要组装矩阵，而是在assemble_rhs()中组装右手边。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_system() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 1); </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, </div><div class="line">                          quadrature_formula, </div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); </div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell); </div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell); </div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">  RightHandSide&lt;dim&gt;     rhs; </div><div class="line">  std::vector&lt;double&gt;    rhs_values(n_q_points); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>()) </div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned()) </div><div class="line">      { </div><div class="line">        cell_matrix = 0; </div><div class="line">        cell_rhs    = 0; </div><div class="line"></div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient_value = </div><div class="line">          coefficient.average_value(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>()); </div><div class="line">        rhs.value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(), rhs_values); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">            { </div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) += </div><div class="line">                  coefficient_value *                <span class="comment">// epsilon(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_point) * <span class="comment">// * grad phi_i(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_point) * <span class="comment">// * grad phi_j(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);            <span class="comment">// * dx </span></div><div class="line"></div><div class="line">              cell_rhs(i) += </div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_point) * <span class="comment">// grad phi_i(x) </span></div><div class="line">                rhs_values[q_point] *               <span class="comment">// * f(x) </span></div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);             <span class="comment">// * dx </span></div><div class="line">            } </div><div class="line"></div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices); </div><div class="line">        constraints.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_matrix, </div><div class="line">                                               cell_rhs, </div><div class="line">                                               local_dof_indices, </div><div class="line">                                               system_matrix, </div><div class="line">                                               right_hand_side); </div><div class="line">      } </div><div class="line"></div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">  right_hand_side.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemassemble_multigrid"></a> </p><h4>LaplaceProblem::assemble_multigrid()</h4>
<p>下面的函数为基于矩阵的GMG方法组装和存储多级矩阵。这个函数与 <a class="el" href="step_16.html">step-16</a> 中的函数类似，只是在这里它适用于分布式网格。这个区别在于增加了一个条件，即我们只在本地拥有的水平单元上进行组装，并为每个被建立的矩阵调用压缩（）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_multigrid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble multigrid&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 1); </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, </div><div class="line">                          quadrature_formula, </div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); </div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell); </div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line"></div><div class="line">  std::vector&lt;AffineConstraints&lt;double&gt;&gt; boundary_constraints( </div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">    { </div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> dof_set; </div><div class="line">      <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                    level, </div><div class="line">                                                    dof_set); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dof_set); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].add_lines( </div><div class="line">        mg_constrained_dofs.get_refinement_edge_indices(level)); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].add_lines( </div><div class="line">        mg_constrained_dofs.get_boundary_indices(level)); </div><div class="line"></div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].close(); </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#ga7295c669f32e78c45446ddc236f19136">cell_iterators</a>()) </div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;level_subdomain_id() == triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>()) </div><div class="line">      { </div><div class="line">        cell_matrix = 0; </div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient_value = </div><div class="line">          coefficient.average_value(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>()); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) += </div><div class="line">                coefficient_value * fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_point) * </div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_point) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point); </div><div class="line"></div><div class="line">        cell-&gt;get_mg_dof_indices(local_dof_indices); </div><div class="line"></div><div class="line">        boundary_constraints[cell-&gt;level()].distribute_local_to_global( </div><div class="line">          cell_matrix, local_dof_indices, mg_matrix[cell-&gt;level()]); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">            <span class="keywordflow">if</span> (mg_constrained_dofs.is_interface_matrix_entry( </div><div class="line">                  cell-&gt;level(), local_dof_indices[i], local_dof_indices[j])) </div><div class="line">              mg_interface_in[cell-&gt;level()].add(local_dof_indices[i], </div><div class="line">                                                 local_dof_indices[j], </div><div class="line">                                                 <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j)); </div><div class="line">      } </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); ++i) </div><div class="line">    { </div><div class="line">      mg_matrix[i].compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">      mg_interface_in[i].compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemassemble_rhs"></a> </p><h4>LaplaceProblem::assemble_rhs()</h4>
<p>这个三要素中的最后一个函数为无矩阵方法组装右手边的向量&ndash;因为在无矩阵框架中，我们不需要组装矩阵，只需要组装右手边就可以了。我们可以通过从上面的<code>assemble_system()</code>函数中提取处理右手边的代码来做到这一点，但是我们决定完全采用无矩阵的方法，也用这种方法进行装配。</p>
<p>结果是一个类似于 <a class="el" href="step_37.html">step-37</a> 中 "使用 FEEvaluation::read_dof_values_plain() 来避免解决约束 "一节中的函数。</p>
<p>这个函数的原因是MatrixFree运算符不考虑非同质的Dirichlet约束，而是将所有的Dirichlet约束视为同质的。为了说明这一点，这里的右手边被组装成残差 \(r_0 = f-Au_0\) ，其中 \(u_0\) 是一个零向量，除了在Dirichlet值中。然后在求解的时候，我们可以看到，解决方案是 \(u = u_0 + A^{-1}r_0\) 。这可以看作是对初始猜测为 \(u_0\) 的线性系统进行的牛顿迭代。下面<code>solve()</code>函数中的CG解计算了 \(A^{-1}r_0\) ，调用<code>constraints.distribution()</code>（直接在后面）增加了 \(u_0\) 。</p>
<p>显然，由于我们考虑的是一个零迪里希特边界的问题，我们可以采取类似于 <a class="el" href="step_37.html">step-37</a> <code>assemble_rhs()</code>的方法，但是这个额外的工作允许我们改变问题声明，如果我们选择的话。</p>
<p>这个函数在积分循环中有两个部分：通过提交梯度的负值将矩阵 \(A\) 的负值应用于 \(u_0\) ，并通过提交值 \(f\) 添加右手边的贡献。我们必须确保使用<code>read_dof_values_plain()</code>来评估 \(u_0\) ，因为<code>read_dof_vaues()</code>会将所有Dirichlet值设置为0。</p>
<p>最后，system_rhs向量的类型是 LA::MPI::Vector, ，但MatrixFree类只对 <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a>. 起作用，因此我们必须使用MatrixFree功能计算右手边，然后使用<code>ChangeVectorType</code>命名空间的函数将其复制到正确的类型。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_rhs() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble right-hand side&quot;</span>); </div><div class="line"></div><div class="line">  MatrixFreeActiveVector solution_copy; </div><div class="line">  MatrixFreeActiveVector right_hand_side_copy; </div><div class="line">  mf_system_matrix.initialize_dof_vector(solution_copy); </div><div class="line">  mf_system_matrix.initialize_dof_vector(right_hand_side_copy); </div><div class="line"></div><div class="line">  solution_copy = 0.; </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution_copy); </div><div class="line">  solution_copy.update_ghost_values(); </div><div class="line">  right_hand_side_copy = 0; </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classTable.html">Table&lt;2, VectorizedArray&lt;double&gt;</a>&gt; &amp;coefficient = </div><div class="line">    *(mf_system_matrix.get_coefficient()); </div><div class="line"></div><div class="line">  RightHandSide&lt;dim&gt; right_hand_side_function; </div><div class="line"></div><div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, degree, degree + 1, 1, double&gt;</a> phi( </div><div class="line">    *mf_system_matrix.get_matrix_free()); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; </div><div class="line">       cell &lt; mf_system_matrix.get_matrix_free()-&gt;n_cell_batches(); </div><div class="line">       ++cell) </div><div class="line">    { </div><div class="line">      phi.reinit(cell); </div><div class="line">      phi.read_dof_values_plain(solution_copy); </div><div class="line">      phi.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>); </div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; phi.n_q_points; ++q) </div><div class="line">        { </div><div class="line">          phi.submit_gradient(-1.0 * </div><div class="line">                                (coefficient(cell, 0) * phi.get_gradient(q)), </div><div class="line">                              q); </div><div class="line">          phi.submit_value( </div><div class="line">            right_hand_side_function.value(phi.quadrature_point(q)), q); </div><div class="line">        } </div><div class="line"></div><div class="line">      phi.integrate_scatter(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | </div><div class="line">                              <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>, </div><div class="line">                            right_hand_side_copy); </div><div class="line">    } </div><div class="line"></div><div class="line">  right_hand_side_copy.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(right_hand_side, right_hand_side_copy); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemsolve"></a> </p><h4>LaplaceProblem::solve()</h4>
<p>这里我们设置了多网格预处理程序，测试了单个V型周期的时间，并解决了线性系统。不出所料，这是三种方法差别最大的地方之一。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::solve() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(1000, 1.e-10 * right_hand_side.l2_norm()); </div><div class="line">  solver_control.<a class="code" href="classSolverControl.html#a6d99741765243ccb65da4ff66558cf41">enable_history_data</a>(); </div><div class="line"></div><div class="line">  solution = 0.; </div></div><!-- fragment --><p>无矩阵GMG方法的求解器类似于 <a class="el" href="step_37.html">step-37</a> ，除了增加一些接口矩阵，完全类似于 <a class="el" href="step_16.html">step-16</a> 。</p>
<div class="fragment"><div class="line"><span class="keywordflow">switch</span> (settings.solver) </div><div class="line">  { </div><div class="line">    <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">      { </div><div class="line">        computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">        <a class="code" href="classMGTransferMatrixFree.html">MGTransferMatrixFree&lt;dim, float&gt;</a> mg_transfer(mg_constrained_dofs); </div><div class="line">        mg_transfer.<a class="code" href="classMGTransferPrebuilt.html#a305c601c3f8c17c957a5ce71c95b933a">build</a>(dof_handler); </div><div class="line"></div><div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> coarse_solver_control(1000, 1e-12, <span class="keyword">false</span>, <span class="keyword">false</span>); </div><div class="line">        <a class="code" href="classSolverCG.html">SolverCG&lt;MatrixFreeLevelVector&gt;</a> coarse_solver(coarse_solver_control); </div><div class="line">        <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>            <a class="code" href="structidentity.html">identity</a>; </div><div class="line">        <a class="code" href="classMGCoarseGridIterativeSolver.html">MGCoarseGridIterativeSolver</a>&lt;MatrixFreeLevelVector, </div><div class="line">                                    <a class="code" href="classSolverCG.html">SolverCG&lt;MatrixFreeLevelVector&gt;</a>, </div><div class="line">                                    MatrixFreeLevelMatrix, </div><div class="line">                                    <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>&gt; </div><div class="line">          coarse_grid_solver(coarse_solver, mf_mg_matrix[0], identity); </div><div class="line"></div><div class="line">        <span class="keyword">using</span> Smoother = <a class="code" href="classPreconditionJacobi.html">::PreconditionJacobi&lt;MatrixFreeLevelMatrix&gt;</a>; </div><div class="line">        <a class="code" href="classMGSmootherPrecondition.html">MGSmootherPrecondition</a>&lt;MatrixFreeLevelMatrix, </div><div class="line">                               Smoother, </div><div class="line">                               MatrixFreeLevelVector&gt; </div><div class="line">          smoother; </div><div class="line">        smoother.<a class="code" href="classMGCoarseGridIterativeSolver.html#a80c597f7ca12c63b070ab0a5605f0a3a">initialize</a>(mf_mg_matrix, </div><div class="line">                            <span class="keyword">typename</span> Smoother::AdditionalData( </div><div class="line">                              settings.smoother_dampen)); </div><div class="line">        smoother.set_steps(settings.smoother_steps); </div><div class="line"></div><div class="line">        <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;MatrixFreeLevelVector&gt;</a> mg_m(mf_mg_matrix); </div><div class="line"></div><div class="line">        <a class="code" href="classMGLevelObject.html">MGLevelObject</a>&lt; </div><div class="line">          <a class="code" href="classMatrixFreeOperators_1_1MGInterfaceOperator.html">MatrixFreeOperators::MGInterfaceOperator&lt;MatrixFreeLevelMatrix&gt;</a>&gt; </div><div class="line">          mg_interface_matrices; </div><div class="line">        mg_interface_matrices.<a class="code" href="classMGLevelObject.html#a16213121f9153bd08f49652a11886259">resize</a>(0, triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() - 1); </div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line">             ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">          mg_interface_matrices[level].initialize(mf_mg_matrix[level]); </div><div class="line">        <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;MatrixFreeLevelVector&gt;</a> mg_interface(mg_interface_matrices); </div><div class="line"></div><div class="line">        <a class="code" href="classMultigrid.html">Multigrid&lt;MatrixFreeLevelVector&gt;</a> <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">          mg_m, coarse_grid_solver, mg_transfer, smoother, smoother); </div><div class="line">        <a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_interface, mg_interface); </div><div class="line"></div><div class="line">        <a class="code" href="classPreconditionMG.html">PreconditionMG</a>&lt;dim, </div><div class="line">                       MatrixFreeLevelVector, </div><div class="line">                       <a class="code" href="classMGTransferMatrixFree.html">MGTransferMatrixFree&lt;dim, float&gt;</a>&gt; </div><div class="line">          preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div></div><!-- fragment --><p>将求解向量和右手边从 LA::MPI::Vector 复制到 <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a> ，这样我们就可以解决了。</p>
<div class="fragment"><div class="line">MatrixFreeActiveVector solution_copy; </div><div class="line">MatrixFreeActiveVector right_hand_side_copy; </div><div class="line">mf_system_matrix.initialize_dof_vector(solution_copy); </div><div class="line">mf_system_matrix.initialize_dof_vector(right_hand_side_copy); </div><div class="line"></div><div class="line"><a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(solution_copy, solution); </div><div class="line"><a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(right_hand_side_copy, right_hand_side); </div><div class="line">computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div></div><!-- fragment --><p>1个V型周期的时间安排。</p>
<div class="fragment"><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                            <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#ad2369ede91810bf1f8b40edccad48175">vmult</a>(solution_copy, right_hand_side_copy); </div><div class="line">} </div><div class="line">solution_copy = 0.; </div></div><!-- fragment --><p>解出线性系统，更新解的鬼魂值，复制回 LA::MPI::Vector 并分配约束。</p>
<div class="fragment"><div class="line">  { </div><div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;MatrixFreeActiveVector&gt;</a> solver(solver_control); </div><div class="line"></div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">    solver.solve(mf_system_matrix, </div><div class="line">                 solution_copy, </div><div class="line">                 right_hand_side_copy, </div><div class="line">                 preconditioner); </div><div class="line">  } </div><div class="line"></div><div class="line">  solution_copy.update_ghost_values(); </div><div class="line">  <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(solution, solution_copy); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line">  <span class="keywordflow">break</span>; </div><div class="line">} </div></div><!-- fragment --><p>基于矩阵的GMG方法的求解器，类似于 <a class="el" href="step_16.html">step-16</a> ，只是使用了雅可比平滑器，而不是SOR平滑器（该平滑器没有并行实现）。</p>
<div class="fragment"><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">        { </div><div class="line">          computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">          <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;VectorType&gt;</a> mg_transfer(mg_constrained_dofs); </div><div class="line">          mg_transfer.<a class="code" href="classMGTransferPrebuilt.html#a305c601c3f8c17c957a5ce71c95b933a">build</a>(dof_handler); </div><div class="line"></div><div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a>        coarse_solver_control(1000, 1e-12, <span class="keyword">false</span>, <span class="keyword">false</span>); </div><div class="line">          <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> coarse_solver(coarse_solver_control); </div><div class="line">          <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a> identity; </div><div class="line">          <a class="code" href="classMGCoarseGridIterativeSolver.html">MGCoarseGridIterativeSolver</a>&lt;<a class="code" href="classVectorType.html">VectorType</a>, </div><div class="line">                                      <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a>, </div><div class="line">                                      MatrixType, </div><div class="line">                                      <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>&gt; </div><div class="line">            coarse_grid_solver(coarse_solver, mg_matrix[0], identity); </div><div class="line"></div><div class="line">          <span class="keyword">using</span> Smoother = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a84fd288bacabd1a7e3408885fb0fad01">LA::MPI::PreconditionJacobi</a>; </div><div class="line">          <a class="code" href="classMGSmootherPrecondition.html">MGSmootherPrecondition&lt;MatrixType, Smoother, VectorType&gt;</a> smoother; </div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          smoother.<a class="code" href="classMGSmootherPrecondition.html#a3cb789b815bf6719eee79e2137c9bd84">initialize</a>(mg_matrix); </div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>( </div><div class="line">            settings.smoother_dampen == 1.0, </div><div class="line">            <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>( </div><div class="line">              <span class="stringliteral">&quot;PETSc&#39;s PreconditionJacobi has no support for a damping parameter.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          smoother.<a class="code" href="classMGSmootherPrecondition.html#a3cb789b815bf6719eee79e2137c9bd84">initialize</a>(mg_matrix, settings.smoother_dampen); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          smoother.<a class="code" href="classMGSmoother.html#a9976182b6b272aac7800a8fbf18c8ab9">set_steps</a>(settings.smoother_steps); </div><div class="line"></div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_m(mg_matrix); </div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_in(mg_interface_in); </div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_out(mg_interface_in); </div><div class="line"></div><div class="line">          <a class="code" href="classMultigrid.html">Multigrid&lt;VectorType&gt;</a> <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">            mg_m, coarse_grid_solver, mg_transfer, smoother, smoother); </div><div class="line">          <a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_out, mg_in); </div><div class="line"></div><div class="line">          <a class="code" href="classPreconditionMG.html">PreconditionMG&lt;dim, VectorType, MGTransferPrebuilt&lt;VectorType&gt;</a>&gt; </div><div class="line">            preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div><div class="line"></div><div class="line">          computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div></div><!-- fragment --><p>1个V型周期的计时。</p>
<div class="fragment"><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                            <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#ad2369ede91810bf1f8b40edccad48175">vmult</a>(solution, right_hand_side); </div><div class="line">} </div><div class="line">solution = 0.; </div></div><!-- fragment --><p>解决线性系统和分配约束。</p>
<div class="fragment"><div class="line">  { </div><div class="line">    SolverCG&lt;VectorType&gt; solver(solver_control); </div><div class="line"></div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">    solver.solve(system_matrix, </div><div class="line">                 solution, </div><div class="line">                 right_hand_side, </div><div class="line">                 preconditioner); </div><div class="line">  } </div><div class="line"></div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line"></div><div class="line">} </div></div><!-- fragment --><p>AMG方法的求解器，类似于 <a class="el" href="step_40.html">step-40</a> 。</p>
<div class="fragment"><div class="line">      <span class="keywordflow">case</span> Settings::amg: </div><div class="line">        { </div><div class="line">          computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">PreconditionAMG</a>                 preconditioner; </div><div class="line">          PreconditionAMG::AdditionalData Amg_data; </div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          Amg_data.symmetric_operator = <span class="keyword">true</span>; </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          Amg_data.elliptic              = <span class="keyword">true</span>; </div><div class="line">          Amg_data.smoother_type         = <span class="stringliteral">&quot;Jacobi&quot;</span>; </div><div class="line">          Amg_data.higher_order_elements = <span class="keyword">true</span>; </div><div class="line">          Amg_data.smoother_sweeps       = settings.smoother_steps; </div><div class="line">          Amg_data.aggregation_threshold = 0.02; </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          Amg_data.output_details = <span class="keyword">false</span>; </div><div class="line"></div><div class="line">          preconditioner.initialize(system_matrix, Amg_data); </div><div class="line">          computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div></div><!-- fragment --><p>1个V型周期的计时。</p>
<div class="fragment"><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                            <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">  preconditioner.vmult(solution, right_hand_side); </div><div class="line">} </div><div class="line">solution = 0.; </div></div><!-- fragment --><p>解决线性系统和分配约束。</p>
<div class="fragment"><div class="line">          { </div><div class="line">            SolverCG&lt;VectorType&gt; solver(solver_control); </div><div class="line"></div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">            solver.solve(system_matrix, </div><div class="line">                         solution, </div><div class="line">                         right_hand_side, </div><div class="line">                         preconditioner); </div><div class="line">          } </div><div class="line">          constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>()); </div><div class="line">    } </div><div class="line"></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Number of CG iterations:      &quot;</span> &lt;&lt; solver_control.last_step() </div><div class="line">        &lt;&lt; std::endl; </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="Theerrorestimator"></a> </p><h3>The error estimator</h3>
<p>我们使用FEInterfaceValues类来组装一个误差估计器，以决定哪些单元需要细化。请看介绍中对单元和面积分的确切定义。为了使用该方法，我们为 <a class="el" href="group__MeshWorker.html#ga76ec61fbd188fb320fe8ca166a79b322">MeshWorker::mesh_loop()</a> 定义了Scratch和Copy对象，下面的大部分代码本质上与 <a class="el" href="step_12.html">step-12</a> 中已经设置的一样（或者至少精神上相似）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">struct </span>ScratchData </div><div class="line">{ </div><div class="line">  ScratchData(<span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      mapping, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe, </div><div class="line">              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        quadrature_degree, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         interface_update_flags) </div><div class="line">    : fe_values(mapping, fe, <a class="code" href="classQGauss.html">QGauss</a>&lt;dim&gt;(quadrature_degree), update_flags) </div><div class="line">    , fe_interface_values(mapping, </div><div class="line">                          fe, </div><div class="line">                          <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt;(quadrature_degree), </div><div class="line">                          interface_update_flags) </div><div class="line">  {} </div><div class="line"></div><div class="line">  ScratchData(<span class="keyword">const</span> ScratchData&lt;dim&gt; &amp;scratch_data) </div><div class="line">    : fe_values(scratch_data.fe_values.get_mapping(), </div><div class="line">                scratch_data.fe_values.get_fe(), </div><div class="line">                scratch_data.fe_values.get_quadrature(), </div><div class="line">                scratch_data.fe_values.get_update_flags()) </div><div class="line">    , fe_interface_values(scratch_data.fe_values.get_mapping(), </div><div class="line">                          scratch_data.fe_values.get_fe(), </div><div class="line">                          scratch_data.fe_interface_values.get_quadrature(), </div><div class="line">                          scratch_data.fe_interface_values.get_update_flags()) </div><div class="line">  {} </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>          fe_values; </div><div class="line">  <a class="code" href="classFEInterfaceValues.html">FEInterfaceValues&lt;dim&gt;</a> fe_interface_values; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">struct </span>CopyData </div><div class="line">{ </div><div class="line">  CopyData() </div><div class="line">    : <a class="code" href="grid__tools_8cc.html#aff11e57deb99b39b7d7d26cf866798f2">cell_index</a>(<a class="code" href="namespacenumbers.html">numbers</a>::<a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">invalid_unsigned_int</a>) </div><div class="line">    , value(0.) </div><div class="line">  {} </div><div class="line"></div><div class="line">  CopyData(<span class="keyword">const</span> CopyData &amp;) = <span class="keywordflow">default</span>; </div><div class="line"></div><div class="line">  <span class="keyword">struct </span>FaceData </div><div class="line">  { </div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_indices[2]; </div><div class="line">    <span class="keywordtype">double</span>       values[2]; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          <a class="code" href="grid__tools_8cc.html#aff11e57deb99b39b7d7d26cf866798f2">cell_index</a>; </div><div class="line">  <span class="keywordtype">double</span>                value; </div><div class="line">  std::vector&lt;FaceData&gt; face_data; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::estimate() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Estimate&quot;</span>); </div><div class="line"></div><div class="line">  VectorType temp_solution; </div><div class="line">  temp_solution.reinit(locally_owned_dofs, </div><div class="line">                       locally_relevant_dofs, </div><div class="line">                       mpi_communicator); </div><div class="line">  temp_solution = solution; </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line"></div><div class="line">  estimated_error_square_per_cell.reinit(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line"></div><div class="line">  <span class="keyword">using</span> Iterator = <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a>; </div></div><!-- fragment --><p>剩余单元的汇编程序 \(h^2 \| f + \epsilon \triangle u \|_K^2\) 。</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> cell_worker = [&amp;](<span class="keyword">const</span> Iterator &amp;  cell, </div><div class="line">                       ScratchData&lt;dim&gt; &amp;scratch_data, </div><div class="line">                       CopyData &amp;        copy_data) { </div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;fe_values = scratch_data.fe_values; </div><div class="line">  fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">  RightHandSide&lt;dim&gt; rhs; </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       rhs_value = rhs.value(cell-&gt;center()); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> nu = coefficient.value(cell-&gt;center()); </div><div class="line"></div><div class="line"></div><div class="line">  fe_values.<a class="code" href="classFEValuesBase.html#ae8f183c9d6da0c7daf9d345e0bc91b0a">get_function_hessians</a>(temp_solution, <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaccf663e018d31c264b769c80bd91db4d">hessians</a>); </div><div class="line"></div><div class="line">  copy_data.cell_index = cell-&gt;active_cell_index(); </div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> residual_norm_square = 0.; </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> k = 0; k &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++k) </div><div class="line">    { </div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> residual = (rhs_value + nu * <a class="code" href="classSymmetricTensor.html#a9137b6052702150e8e5b1188d1971906">trace</a>(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaccf663e018d31c264b769c80bd91db4d">hessians</a>[k])); </div><div class="line">      residual_norm_square += residual * residual * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(k); </div><div class="line">    } </div><div class="line"></div><div class="line">  copy_data.value = </div><div class="line">    cell-&gt;diameter() * cell-&gt;diameter() * residual_norm_square; </div><div class="line">}; </div></div><!-- fragment --><p>脸部术语的汇编器 \(\sum_F h_F \| \jump{\epsilon \nabla u \cdot n} \|_F^2\) 。</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> face_worker = [&amp;](<span class="keyword">const</span> Iterator &amp;    cell, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;f, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;sf, </div><div class="line">                       <span class="keyword">const</span> Iterator &amp;    ncell, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;nf, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;nsf, </div><div class="line">                       ScratchData&lt;dim&gt; &amp;  scratch_data, </div><div class="line">                       CopyData &amp;          copy_data) { </div><div class="line">  <a class="code" href="classFEInterfaceValues.html">FEInterfaceValues&lt;dim&gt;</a> &amp;fe_interface_values = </div><div class="line">    scratch_data.fe_interface_values; </div><div class="line">  fe_interface_values.<a class="code" href="classFEInterfaceValues.html#af6aa20b6652c2605d4cee36021f6bcd2">reinit</a>(cell, f, sf, ncell, nf, nsf); </div><div class="line"></div><div class="line">  copy_data.face_data.emplace_back(); </div><div class="line">  CopyData::FaceData &amp;copy_data_face = copy_data.face_data.back(); </div><div class="line"></div><div class="line">  copy_data_face.cell_indices[0] = cell-&gt;active_cell_index(); </div><div class="line">  copy_data_face.cell_indices[1] = ncell-&gt;active_cell_index(); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> coeff1 = coefficient.value(cell-&gt;center()); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> coeff2 = coefficient.value(ncell-&gt;center()); </div><div class="line"></div><div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_u[2]; </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 2; ++i) </div><div class="line">    { </div><div class="line">      grad_u[i].resize(fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a41f6734be1313f750fa8b3b7ba470f35">n_quadrature_points</a>); </div><div class="line">      fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a6ac7ddd5ac77cc4a1925ec5f0b100bf2">get_fe_face_values</a>(i).get_function_gradients( </div><div class="line">        temp_solution, grad_u[i]); </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> jump_norm_square = 0.; </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> qpoint = 0; </div><div class="line">       qpoint &lt; fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a41f6734be1313f750fa8b3b7ba470f35">n_quadrature_points</a>; </div><div class="line">       ++qpoint) </div><div class="line">    { </div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> jump = </div><div class="line">        coeff1 * grad_u[0][qpoint] * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a1a52fcfa2f54f153cc7cdda3788e5ac0">normal</a>(qpoint) - </div><div class="line">        coeff2 * grad_u[1][qpoint] * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a1a52fcfa2f54f153cc7cdda3788e5ac0">normal</a>(qpoint); </div><div class="line"></div><div class="line">      jump_norm_square += jump * jump * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a9f8f06f7da061e1c2a20c5cc68a89db1">JxW</a>(qpoint); </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> h           = cell-&gt;face(f)-&gt;measure(); </div><div class="line">  copy_data_face.values[0] = 0.5 * h * jump_norm_square; </div><div class="line">  copy_data_face.values[1] = copy_data_face.values[0]; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">auto</span> copier = [&amp;](<span class="keyword">const</span> CopyData &amp;copy_data) { </div><div class="line">  <span class="keywordflow">if</span> (copy_data.cell_index != <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>) </div><div class="line">    estimated_error_square_per_cell[copy_data.cell_index] += copy_data.value; </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;cdf : copy_data.face_data) </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; 2; ++j) </div><div class="line">      estimated_error_square_per_cell[cdf.cell_indices[j]] += cdf.values[j]; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_gauss_points = degree + 1; </div><div class="line">ScratchData&lt;dim&gt;   scratch_data(mapping, </div><div class="line">                              fe, </div><div class="line">                              n_gauss_points, </div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | </div><div class="line">                                <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>, </div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                                <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>); </div><div class="line">CopyData           copy_data; </div></div><!-- fragment --><p>我们需要对每个内部面进行一次装配，但我们需要确保两个进程都对本地拥有的单元和幽灵单元之间的面术语进行装配。这可以通过设置 <a class="el" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa9396964e7e270fe0a0c5d01474721c24">MeshWorker::assemble_ghost_faces_both</a> 标志来实现。我们需要这样做，因为我们不在这里交流误差估计器的贡献。</p>
<div class="fragment"><div class="line">  <a class="code" href="group__MeshWorker.html#ga76ec61fbd188fb320fe8ca166a79b322">MeshWorker::mesh_loop</a>(dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(), </div><div class="line">                        dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>(), </div><div class="line">                        cell_worker, </div><div class="line">                        copier, </div><div class="line">                        scratch_data, </div><div class="line">                        copy_data, </div><div class="line">                        <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa44a76e905b1d4cd80af387b5fac4d8aa">MeshWorker::assemble_own_cells</a> | </div><div class="line">                          <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa9396964e7e270fe0a0c5d01474721c24">MeshWorker::assemble_ghost_faces_both</a> | </div><div class="line">                          <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa47c6806a06155c94191629fae2755763">MeshWorker::assemble_own_interior_faces_once</a>, </div><div class="line">                          <span class="comment">/*boundary_worker=*/</span><span class="keyword">nullptr</span>, face_worker);</div><div class="line"></div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_error_estimate = </div><div class="line">    <a class="code" href="vectorization_8h.html#a303f564e3c189251976da401ee2e44fa">std::sqrt</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a>(estimated_error_square_per_cell.l1_norm(), </div><div class="line">                                  mpi_communicator)); </div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Global error estimate:        &quot;</span> &lt;&lt; global_error_estimate </div><div class="line">        &lt;&lt; std::endl; </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemrefine_grid"></a> </p><h4>LaplaceProblem::refine_grid()</h4>
<p>我们使用存储在向量 <code>estimate_vector</code> 中的单元估计器，并细化固定数量的单元（这里选择的是每一步中大约两倍的DoFs数量）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::refine_grid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Refine grid&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> refinement_fraction = 1. / (<a class="code" href="vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2.0, dim) - 1.); </div><div class="line">  <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>( </div><div class="line">    triangulation, estimated_error_square_per_cell, refinement_fraction, 0.0); </div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>(); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemoutput_results"></a> </p><h4>LaplaceProblem::output_results()</h4>
<p>output_results()函数与许多教程中的函数类似（例如，见 <a class="el" href="step_40.html">step-40</a> ）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Output results&quot;</span>); </div><div class="line"></div><div class="line">  VectorType temp_solution; </div><div class="line">  temp_solution.reinit(locally_owned_dofs, </div><div class="line">                       locally_relevant_dofs, </div><div class="line">                       mpi_communicator); </div><div class="line">  temp_solution = solution; </div><div class="line"></div><div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out; </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temp_solution, <span class="stringliteral">&quot;solution&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i) </div><div class="line">    subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>(); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : triangulation.<a class="code" href="group__CPP11.html#ga4288670ae5bd80367e24918d542cb2d8">active_cell_iterators</a>()) </div><div class="line">    <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>(cell-&gt;active_cell_index()) = cell-&gt;level(); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(level, <span class="stringliteral">&quot;level&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (estimated_error_square_per_cell.size() &gt; 0) </div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(estimated_error_square_per_cell, </div><div class="line">                             <span class="stringliteral">&quot;estimated_error_square_per_cell&quot;</span>); </div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::string pvtu_filename = data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>( </div><div class="line">    <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2 <span class="comment">/*n_digits*/</span>, 1 <span class="comment">/*n_groups*/</span>); </div><div class="line"></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Wrote &quot;</span> &lt;&lt; pvtu_filename &lt;&lt; std::endl; </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemrun"></a> </p><h4><a class="el" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">LaplaceProblem::run()</a></h4>
<p>和大多数教程一样，这个函数调用上面定义的各种函数来设置、组合、求解和输出结果。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">LaplaceProblem&lt;dim, degree&gt;::run</a>() </div><div class="line">{ </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; settings.n_steps; ++cycle) </div><div class="line">    { </div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">if</span> (cycle &gt; 0) </div><div class="line">        refine_grid(); </div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span> </div><div class="line">            &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#a584733c8499dbd140694bfe04e0963ca">n_global_active_cells</a>(); </div></div><!-- fragment --><p>我们只为GMG方法输出层次单元数据（与下面的DoF数据相同）。请注意，对于AMG来说，分区效率是不相关的，因为在计算过程中没有分布或使用层次结构。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">    settings.solver == Settings::gmg_mb) </div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() &lt;&lt; <span class="stringliteral">&quot; global levels)&quot;</span> </div><div class="line">        &lt;&lt; std::endl </div><div class="line">        &lt;&lt; <span class="stringliteral">&quot;   Partition efficiency:         &quot;</span> </div><div class="line">        &lt;&lt; 1.0 / <a class="code" href="namespaceMGTools.html#a8776ac550d9ac85e7e0db51625935673">MGTools::workload_imbalance</a>(triangulation); </div><div class="line">pcout &lt;&lt; std::endl; </div><div class="line"></div><div class="line">setup_system(); </div></div><!-- fragment --><p>只为GMG设置多级层次结构。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">    settings.solver == Settings::gmg_mb) </div><div class="line">  setup_multigrid(); </div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(); </div><div class="line"><span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">    settings.solver == Settings::gmg_mb) </div><div class="line">  { </div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot; (by level: &quot;</span>; </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line">         ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">      pcout &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level) </div><div class="line">            &lt;&lt; (level == triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() - 1 ? <span class="stringliteral">&quot;)&quot;</span> : </div><div class="line">                                                               <span class="stringliteral">&quot;, &quot;</span>); </div><div class="line">  } </div><div class="line">pcout &lt;&lt; std::endl; </div></div><!-- fragment --><p>对于无矩阵的方法，我们只组装右手边。对于这两种基于矩阵的方法，我们同时装配主动矩阵和右手边，对于基于矩阵的GMG，我们只装配多网格矩阵。</p>
<div class="fragment"><div class="line">      <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf) </div><div class="line">        assemble_rhs(); </div><div class="line">      <span class="keywordflow">else</span> <span class="comment">/*gmg_mb or amg*/</span> </div><div class="line">        { </div><div class="line">          assemble_system(); </div><div class="line">          <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mb) </div><div class="line">            assemble_multigrid(); </div><div class="line">        } </div><div class="line"></div><div class="line">      solve(); </div><div class="line">      estimate(); </div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (settings.output) </div><div class="line">        output_results(cycle); </div><div class="line"></div><div class="line">      computing_timer.print_summary(); </div><div class="line">      computing_timer.reset(); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="Themainfunction"></a> </p><h3>The main() function</h3>
<p>这是一个类似于 <a class="el" href="step_40.html">step-40</a> 的主函数，但我们要求用户传递一个.prm文件作为唯一的命令行参数（参见 <a class="el" href="step_29.html">step-29</a> 和ParameterHandler类的文档，以了解关于参数文件的完整讨论）。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) </div><div class="line">{ </div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div><div class="line">  <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> settings; </div><div class="line">  <span class="keywordflow">if</span> (!settings.try_parse((argc &gt; 1) ? (argv[1]) : <span class="stringliteral">&quot;&quot;</span>)) </div><div class="line">    <span class="keywordflow">return</span> 0; </div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree = 2; </div><div class="line"></div><div class="line">      <span class="keywordflow">switch</span> (settings.dimension) </div><div class="line">        { </div><div class="line">          <span class="keywordflow">case</span> 2: </div><div class="line">            { </div><div class="line">              LaplaceProblem&lt;2, fe_degree&gt; test(settings); </div><div class="line">              test.run(); </div><div class="line"></div><div class="line">              <span class="keywordflow">break</span>; </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">case</span> 3: </div><div class="line">            { </div><div class="line">              LaplaceProblem&lt;3, fe_degree&gt; test(settings); </div><div class="line">              test.run(); </div><div class="line"></div><div class="line">              <span class="keywordflow">break</span>; </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">default</span>: </div><div class="line">            <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;This program only works in 2d and 3d.&quot;</span>)); </div><div class="line">        } </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      MPI_Abort(MPI_COMM_WORLD, 1); </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (...) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      MPI_Abort(MPI_COMM_WORLD, 2); </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0; </div><div class="line">} </div></div><!-- fragment --><p> examples/step-50/doc/results.dox</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>当你使用以下命令运行该程序时</p>
<div class="fragment"><div class="line">mpirun -np 16 ./step-50  gmg_mf_2d.prm</div></div><!-- fragment --><p>屏幕输出应该如下。</p>
<div class="fragment"><div class="line">Cycle 0:</div><div class="line">   Number of active cells:       12 (2 global levels)</div><div class="line">   Partition efficiency:         0.1875</div><div class="line">   Number of degrees of freedom: 65 (by level: 21, 65)</div><div class="line">   Number of CG iterations:      10</div><div class="line">   Global error estimate:        0.355373</div><div class="line">   Wrote solution_00.pvtu</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">+---------------------------------------------+------------+------------+</div><div class="line">| Total wallclock time elapsed since start    |    0.0163s |            |</div><div class="line">|                                             |            |            |</div><div class="line">| Section                         | no. calls |  wall time | % of total |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line">| Assemble right-hand side        |         1 |  0.000374s |       2.3% |</div><div class="line">| Estimate                        |         1 |  0.000724s |       4.4% |</div><div class="line">| Output results                  |         1 |   0.00277s |        17% |</div><div class="line">| Setup                           |         1 |   0.00225s |        14% |</div><div class="line">| Setup multigrid                 |         1 |   0.00181s |        11% |</div><div class="line">| Solve                           |         1 |   0.00364s |        22% |</div><div class="line">| Solve: 1 multigrid <a class="code" href="namespaceLAPACKSupport.html#aee5ef58d11434eb1d6a665e64bf17292">V</a>-cycle      |         1 |  0.000354s |       2.2% |</div><div class="line">| Solve: CG                       |         1 |   0.00151s |       9.3% |</div><div class="line">| Solve: Preconditioner setup     |         1 |   0.00125s |       7.7% |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line"></div><div class="line"></div><div class="line">Cycle 1:</div><div class="line">   Number of active cells:       24 (3 global levels)</div><div class="line">   Partition efficiency:         0.276786</div><div class="line">   Number of degrees of freedom: 139 (by level: 21, 65, 99)</div><div class="line">   Number of CG iterations:      10</div><div class="line">   Global error estimate:        0.216726</div><div class="line">   Wrote solution_01.pvtu</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">+---------------------------------------------+------------+------------+</div><div class="line">| Total wallclock time elapsed since start    |    0.0169s |            |</div><div class="line">|                                             |            |            |</div><div class="line">| Section                         | no. calls |  wall time | % of total |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line">| Assemble right-hand side        |         1 |  0.000309s |       1.8% |</div><div class="line">| Estimate                        |         1 |   0.00156s |       9.2% |</div><div class="line">| Output results                  |         1 |   0.00222s |        13% |</div><div class="line">| Refine grid                     |         1 |   0.00278s |        16% |</div><div class="line">| Setup                           |         1 |   0.00196s |        12% |</div><div class="line">| Setup multigrid                 |         1 |    0.0023s |        14% |</div><div class="line">| Solve                           |         1 |   0.00565s |        33% |</div><div class="line">| Solve: 1 multigrid <a class="code" href="namespaceLAPACKSupport.html#aee5ef58d11434eb1d6a665e64bf17292">V</a>-cycle      |         1 |  0.000349s |       2.1% |</div><div class="line">| Solve: CG                       |         1 |   0.00285s |        17% |</div><div class="line">| Solve: Preconditioner setup     |         1 |   0.00195s |        12% |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line"></div><div class="line"></div><div class="line">Cycle 2:</div><div class="line">   Number of active cells:       51 (4 global levels)</div><div class="line">   Partition efficiency:         0.41875</div><div class="line">   Number of degrees of freedom: 245 (by level: 21, 65, 225, 25)</div><div class="line">   Number of CG iterations:      11</div><div class="line">   Global error estimate:        0.112098</div><div class="line">   Wrote solution_02.pvtu</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">+---------------------------------------------+------------+------------+</div><div class="line">| Total wallclock time elapsed since start    |    0.0183s |            |</div><div class="line">|                                             |            |            |</div><div class="line">| Section                         | no. calls |  wall time | % of total |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line">| Assemble right-hand side        |         1 |  0.000274s |       1.5% |</div><div class="line">| Estimate                        |         1 |   0.00127s |       6.9% |</div><div class="line">| Output results                  |         1 |   0.00227s |        12% |</div><div class="line">| Refine grid                     |         1 |    0.0024s |        13% |</div><div class="line">| Setup                           |         1 |   0.00191s |        10% |</div><div class="line">| Setup multigrid                 |         1 |   0.00295s |        16% |</div><div class="line">| Solve                           |         1 |   0.00702s |        38% |</div><div class="line">| Solve: 1 multigrid <a class="code" href="namespaceLAPACKSupport.html#aee5ef58d11434eb1d6a665e64bf17292">V</a>-cycle      |         1 |  0.000398s |       2.2% |</div><div class="line">| Solve: CG                       |         1 |   0.00376s |        21% |</div><div class="line">| Solve: Preconditioner setup     |         1 |   0.00238s |        13% |</div><div class="line">+---------------------------------+-----------+------------+------------+</div><div class="line">.</div><div class="line">.</div><div class="line">.</div></div><!-- fragment --><p>在这里，"solve() "函数的时间被分成三部分：设置多网格预处理程序，执行单一的多网格V型循环，以及CG求解器。被计时的V型循环对整个求解来说是不必要的，只是为了让人们了解AMG和GMG的不同成本。还应注意的是，当使用AMG求解器时，"工作量不平衡 "不包括在输出中，因为不需要粗网格的层次结构。</p>
<p>本节中的所有结果都是在英特尔至强铂金8280（Cascade Lake）节点上收集的，这些节点有56个内核，每个节点有192GB，支持AVX-512指令，允许对8个双倍数进行矢量化（矢量化仅用于无矩阵计算）。代码是用gcc 7.1.0和intel-mpi 17.0.3编译的。Trilinos 12.10.1被用于基于矩阵的GMG/AMG计算。</p>
<p>然后我们可以通过调用<a class="el" href="step_50.html">step-50</a>目录下的输入文件来收集各种信息。使用这些文件，并调整网格细化步骤的数量，我们可以得出程序的扩展性如何的信息。</p>
<p>下表给出了该程序在高达256M自由度和7168个处理器上的弱比例计时。(回顾一下，在增加处理器数量的同时，弱缩放保持每个处理器的自由度数量不变；也就是说，它考虑的是越来越大的问题。)这里， \(\mathbb{E}\) 是介绍中的分区效率（也等于1.0/工作量不平衡），"Setup "是设置、设置多重网格、装配和装配多重网格的组合，"Prec "是预处理程序的设置。理想情况下，在每个问题大小上，各个求解器的所有时间都保持不变，但由于分区效率从最大问题大小到最小问题大小从0.371下降到0.161，我们期望看到GMG的时间大约增加 \(0.371/0.161=2.3\) 倍。事实上，这与我们实际得到的情况非常接近。</p>
<table align="center" class="doxtable">
<tr>
<th colspan="4"></th><th></th><th colspan="4">MF-GMG </th><th></th><th colspan="4">MB-GMG </th><th></th><th colspan="4">AMG  </th></tr>
<tr>
<th align="right">Procs </th><th align="right">Cycle </th><th align="right">DoFs </th><th align="right">\(\mathbb{E}\) </th><th></th><th align="right">Setup </th><th align="right">Prec </th><th align="right">Solve </th><th align="right">Total </th><th></th><th align="right">Setup </th><th align="right">Prec </th><th align="right">Solve </th><th align="right">Total </th><th></th><th align="right">Setup </th><th align="right">Prec </th><th align="right">Solve </th><th align="right">Total  </th></tr>
<tr>
<td align="right">112 </td><td align="right">13 </td><td align="right">4M </td><td align="right">0.37 </td><td></td><td align="right">0.742 </td><td align="right">0.393 </td><td align="right">0.200 </td><td align="right">1.335 </td><td></td><td align="right">1.714 </td><td align="right">2.934 </td><td align="right">0.716 </td><td align="right">5.364 </td><td></td><td align="right">1.544 </td><td align="right">0.456 </td><td align="right">1.150 </td><td align="right">3.150  </td></tr>
<tr>
<td align="right">448 </td><td align="right">15 </td><td align="right">16M </td><td align="right">0.29 </td><td></td><td align="right">0.884 </td><td align="right">0.535 </td><td align="right">0.253 </td><td align="right">1.672 </td><td></td><td align="right">1.927 </td><td align="right">3.776 </td><td align="right">1.190 </td><td align="right">6.893 </td><td></td><td align="right">1.544 </td><td align="right">0.456 </td><td align="right">1.150 </td><td align="right">3.150  </td></tr>
<tr>
<td align="right">1,792 </td><td align="right">17 </td><td align="right">65M </td><td align="right">0.22 </td><td></td><td align="right">1.122 </td><td align="right">0.686 </td><td align="right">0.309 </td><td align="right">2.117 </td><td></td><td align="right">2.171 </td><td align="right">4.862 </td><td align="right">1.660 </td><td align="right">8.693 </td><td></td><td align="right">1.654 </td><td align="right">0.546 </td><td align="right">1.460 </td><td align="right">3.660  </td></tr>
<tr>
<td align="right">7,168 </td><td align="right">19 </td><td align="right">256M </td><td align="right">0.16 </td><td></td><td align="right">1.214 </td><td align="right">0.893 </td><td align="right">0.521 </td><td align="right">2.628 </td><td></td><td align="right">2.386 </td><td align="right">7.260 </td><td align="right">2.560 </td><td align="right">12.206 </td><td></td><td align="right">1.844 </td><td align="right">1.010 </td><td align="right">1.890 </td><td align="right">4.744  </td></tr>
</table>
<p>另一方面，最后一组列中的代数多网格相对来说不受网格层次不平衡度增加的影响（因为它不使用网格层次），时间的增长反而是由文献中记载的其他因素驱动的（最明显的是，代数多网格方法的某些部分的算法复杂度似乎是 \({\cal O}(N \log N)\) ，而不是几何多网格的 \({\cal O}(N)\) ）。</p>
<p>上表的短处是，无矩阵的几何多网格方法似乎是解决这个方程的最快方法，即使不是以很大的优势。另一方面，基于矩阵的方法始终是最差的。</p>
<p>下图提供了每种方法的强大扩展结果，也就是说，我们在越来越多的处理器上解决同一个问题。具体来说，我们考虑在56至28672个处理器上，经过16个网格细化周期（32M DoFs）和19个周期（256M DoFs）后的问题。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-50-strong-scaling.png" width="600px"/>
</div>
<p>虽然基于矩阵的GMG求解器和AMG的规模相似，求解时间也相似（至少在每个处理器有大量未知数的情况下&ndash;比如说，几万个），但无矩阵的GMG求解器的规模要好得多，在较粗的网格上，只用八分之一的处理器就能解决较细的问题，与AMG求解器的时间大致相当。反之，在相同数量的处理器上，它可以用大约八分之一的时间解决同样的问题。</p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions </h3>
<p><a class="anchor" id="Testingconvergenceandhigherorderelements"></a></p><h4>Testing convergence and higher order elements </h4>
<p>有限元度目前是硬编码为2，见主类的模板参数。这很容易改变。为了测试，最好是切换到一个有参考解的测试问题。这样，你可以比较错误率。</p>
<p><a class="anchor" id="Coarsesolver"></a></p><h4>Coarse solver </h4>
<p>一个更有趣的例子是涉及到一个更复杂的粗大的网格（见步骤49的启发）。这种情况下的问题是，网格层次的最粗层实际上是相当大的，我们必须考虑如何有效地解决粗层问题。这对代数多网格方法来说不是一个问题，因为它们只是继续建立越来越粗的矩阵层次，而不管它们的几何来源）。</p>
<p>在这里的程序中，我们只是简单地用共轭梯度法解决粗级问题，没有任何预处理程序。如果粗略问题真的很小，这是可以接受的&ndash;例如，如果粗略网格有一个单元，那么粗略网格问题在2d中有一个 \(9\times 9\) 矩阵，在3d中有一个 \(27\times 27\) 矩阵；对于我们在当前程序的 \(L\) 形域上使用的粗略网格，这些大小在2d中是 \(21\times 21\) ，在3d中有 \(117\times 117\) 。但如果粗略的网格由数百或数千个单元组成，这种方法将不再起作用，并可能开始主导每个V型单元的整体运行时间。一个常见的方法是使用代数多网格预处理程序来解决粗网格问题；然而，这将需要组装粗矩阵（即使是无矩阵版本）作为AMG实现的输入。</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* --------------------------------------------------------------------- </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * Copyright (C) 2019 - 2021 by the deal.II authors </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * This file is part of the deal.II library. </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute </span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General </span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either </span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version. </span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at </span></div><div class="line"><span class="comment"> * the top level directory of deal.II. </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * --------------------------------------------------------------------- </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * Author: Thomas C. Clevenger, Clemson University </span></div><div class="line"><span class="comment"> *         Timo Heister, Clemson University </span></div><div class="line"><span class="comment"> *         Guido Kanschat, Heidelberg University </span></div><div class="line"><span class="comment"> *         Martin Kronbichler, Technical University of Munich </span></div><div class="line"><span class="comment"> */</span> </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__base_8h.html">deal.II/base/data_out_base.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#define FORCE_USE_OF_TRILINOS </span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA </div><div class="line">{ </div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \ </span></div><div class="line">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS)) </div><div class="line">  <span class="keyword">using</span> <span class="keyword">namespace</span> dealii::LinearAlgebraPETSc; </div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA </span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS) </span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos; </div><div class="line"><span class="preprocessor">#else </span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required </span></div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">} <span class="comment">// namespace LA </span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_8h.html">deal.II/matrix_free/matrix_free.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="operators_8h.html">deal.II/matrix_free/operators.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__evaluation_8h.html">deal.II/matrix_free/fe_evaluation.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__coarse_8h.html">deal.II/multigrid/mg_coarse.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__constrained__dofs_8h.html">deal.II/multigrid/mg_constrained_dofs.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__matrix_8h.html">deal.II/multigrid/mg_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__smoother_8h.html">deal.II/multigrid/mg_smoother.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__tools_8h.html">deal.II/multigrid/mg_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer_8h.html">deal.II/multigrid/mg_transfer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="multigrid_8h.html">deal.II/multigrid/multigrid.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer__matrix__free_8h.html">deal.II/multigrid/mg_transfer_matrix_free.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__interface__values_8h.html">deal.II/fe/fe_interface_values.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mesh__loop_8h.html">deal.II/meshworker/mesh_loop.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>ChangeVectorTypes </div><div class="line">{ </div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">copy</a>(<a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a> &amp;                                         out, </div><div class="line">            const ::LinearAlgebra::distributed::Vector&lt;number&gt; &amp;in) </div><div class="line">  { </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">::LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rwv( </div><div class="line">      out.locally_owned_elements()); </div><div class="line">    rwv.<a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html#a01a417b8d7b2c5858f49cdc4c663779f">import</a>(in, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, </div><div class="line">                <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;CopyVectorTypes::copy() not implemented for &quot;</span> </div><div class="line">                           <span class="stringliteral">&quot;PETSc vector types.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">    out.import(rwv, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">copy</a>(::<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;number&gt;</a> &amp;out, </div><div class="line">            <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a> &amp;                             in) </div><div class="line">  { </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">::LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rwv; </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">    (void)in; </div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, </div><div class="line">                <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;CopyVectorTypes::copy() not implemented for &quot;</span> </div><div class="line">                           <span class="stringliteral">&quot;PETSc vector types.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">    rwv.<a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html#aaee2ea7c671f9ece558b081b0d104295">reinit</a>(in); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">    out.<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html#af7b743d761233b92e0ed23e6bf37a409">import</a>(rwv, <a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>); </div><div class="line">  } </div><div class="line">} <span class="comment">// namespace ChangeVectorTypes </span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt; </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const override </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <span class="keywordflow">return</span> 1.0; </div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> </div><div class="line">  value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp; <span class="comment">/*p*/</span>, </div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>(1.0); </div><div class="line">  } </div><div class="line">}; </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt; </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p, </div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0) <span class="keyword">const override</span>; </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;p, </div><div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0) <span class="keyword">const</span>; </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  number average_value(<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim, number&gt;</a>&gt; &amp;points) <span class="keyword">const</span>; </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">  std::shared_ptr&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt; make_coefficient_table( </div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree</a>&lt;dim, number, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;mf_storage) <span class="keyword">const</span>; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">if</span> (p[d] &lt; -0.5) </div><div class="line">        <span class="keywordflow">return</span> 100.0; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">return</span> 1.0; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line"><a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> </div><div class="line">Coefficient&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a>&lt;dim, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;p, </div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> return_value = <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>(1.0); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; VectorizedArray&lt;number&gt;::size(); ++i) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>) </div><div class="line">        <span class="keywordflow">if</span> (p[d][i] &lt; -0.5) </div><div class="line">          { </div><div class="line">            return_value[i] = 100.0; </div><div class="line">            <span class="keywordflow">break</span>; </div><div class="line">          } </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> return_value; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">number Coefficient&lt;dim&gt;::average_value( </div><div class="line">  <span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim, number&gt;</a>&gt; &amp;points)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  number average(0); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; points.size(); ++i) </div><div class="line">    average += value(points[i]); </div><div class="line">  average /= points.size(); </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> average; </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> number&gt; </div><div class="line">std::shared_ptr&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt; </div><div class="line">Coefficient&lt;dim&gt;::make_coefficient_table( </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree</a>&lt;dim, number, <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a>&gt; &amp;mf_storage)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <span class="keyword">auto</span> coefficient_table = </div><div class="line">    std::make_shared&lt;Table&lt;2, VectorizedArray&lt;number&gt;&gt;&gt;(); </div><div class="line"></div><div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation</a>&lt;dim, -1, 0, 1, number&gt; fe_eval(mf_storage); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cells    = mf_storage.n_cell_batches(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = fe_eval.n_q_points; </div><div class="line"></div><div class="line">  coefficient_table-&gt;reinit(n_cells, 1); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; cell &lt; <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>; ++cell) </div><div class="line">    { </div><div class="line">      fe_eval.reinit(cell); </div><div class="line"></div><div class="line">      <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;number&gt;</a> average_value = 0.; </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q) </div><div class="line">        average_value += value(fe_eval.quadrature_point(q)); </div><div class="line">      average_value /= n_q_points; </div><div class="line"></div><div class="line">      (*coefficient_table)(cell, 0) = average_value; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> coefficient_table; </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> </div><div class="line">{ </div><div class="line">  <span class="keywordtype">bool</span> try_parse(<span class="keyword">const</span> std::string &amp;prm_filename); </div><div class="line"></div><div class="line">  <span class="keyword">enum</span> <a class="code" href="classSolverType.html">SolverType</a> </div><div class="line">  { </div><div class="line">    gmg_mb, </div><div class="line">    gmg_mf, </div><div class="line">    amg </div><div class="line">  }; </div><div class="line"></div><div class="line">  <a class="code" href="classSolverType.html">SolverType</a> solver; </div><div class="line"></div><div class="line">  <span class="keywordtype">int</span>          dimension; </div><div class="line">  <span class="keywordtype">double</span>       smoother_dampen; </div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> smoother_steps; </div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_steps; </div><div class="line">  <span class="keywordtype">bool</span>         output; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> Settings::try_parse(<span class="keyword">const</span> std::string &amp;prm_filename) </div><div class="line">{ </div><div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm; </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;dim&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(), <span class="stringliteral">&quot;The problem dimension.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;n_steps&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;10&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0), </div><div class="line">                    <span class="stringliteral">&quot;Number of adaptive refinement steps.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;smoother dampen&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;1.0&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0.0), </div><div class="line">                    <span class="stringliteral">&quot;Dampen factor for the smoother.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;smoother steps&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;1&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1), </div><div class="line">                    <span class="stringliteral">&quot;Number of smoother steps.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;solver&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;MF&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Selection.html">Patterns::Selection</a>(<span class="stringliteral">&quot;MF|MB|AMG&quot;</span>), </div><div class="line">                    <span class="stringliteral">&quot;Switch between matrix-free GMG, &quot;</span> </div><div class="line">                    <span class="stringliteral">&quot;matrix-based GMG, and AMG.&quot;</span>); </div><div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;output&quot;</span>, </div><div class="line">                    <span class="stringliteral">&quot;false&quot;</span>, </div><div class="line">                    <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(), </div><div class="line">                    <span class="stringliteral">&quot;Output graphical results.&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (prm_filename.size() == 0) </div><div class="line">    { </div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;****  Error: No input file provided!\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  Error: Call this program as &#39;./step-50 input.prm\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  You may want to use one of the input files in this\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  directory, or use the following default values\n&quot;</span> </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;****  to create an input file:\n&quot;</span>; </div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0) </div><div class="line">        prm.<a class="code" href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">print_parameters</a>(std::cout, <a class="code" href="classParameterHandler.html#a8364dda711b93753c6809eefe2a8e827ae4d13a4598073bfcb69cd0cf4c1f8365">ParameterHandler::Text</a>); </div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      prm.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(prm_filename); </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;e) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD) == 0) </div><div class="line">        std::cerr &lt;&lt; e.what() &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;MF&quot;</span>) </div><div class="line">    this-&gt;solver = gmg_mf; </div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;MB&quot;</span>) </div><div class="line">    this-&gt;solver = gmg_mb; </div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prm.<a class="code" href="classParameterHandler.html#a91cfbaca954f444047302446a4e87125">get</a>(<span class="stringliteral">&quot;solver&quot;</span>) == <span class="stringliteral">&quot;AMG&quot;</span>) </div><div class="line">    this-&gt;solver = amg; </div><div class="line">  <span class="keywordflow">else</span> </div><div class="line">    <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line"></div><div class="line">  this-&gt;dimension       = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;dim&quot;</span>); </div><div class="line">  this-&gt;n_steps         = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;n_steps&quot;</span>); </div><div class="line">  this-&gt;smoother_dampen = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;smoother dampen&quot;</span>); </div><div class="line">  this-&gt;smoother_steps  = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;smoother steps&quot;</span>); </div><div class="line">  this-&gt;output          = prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;output&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>; </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keyword">class </span>LaplaceProblem </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  LaplaceProblem(<span class="keyword">const</span> <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> &amp;settings); </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>(); </div><div class="line"></div><div class="line"><span class="keyword">private</span>: </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">using</span> MatrixType         = <a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>; </div><div class="line">  <span class="keyword">using</span> VectorType         = <a class="code" href="namespaceLinearAlgebraDealII.html#a9fe13d579422411556954ab3f28a59be">LA::MPI::Vector</a>; </div><div class="line">  <span class="keyword">using</span> <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">PreconditionAMG</a>    = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>; </div><div class="line">  <span class="keyword">using</span> <a class="code" href="classPreconditionJacobi.html">PreconditionJacobi</a> = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a84fd288bacabd1a7e3408885fb0fad01">LA::MPI::PreconditionJacobi</a>; </div><div class="line"></div><div class="line">  <span class="keyword">using</span> MatrixFreeLevelMatrix = <a class="code" href="classMatrixFreeOperators_1_1LaplaceOperator.html">MatrixFreeOperators::LaplaceOperator</a>&lt; </div><div class="line">    dim, </div><div class="line">    degree, </div><div class="line">    degree + 1, </div><div class="line">    1, </div><div class="line">    LinearAlgebra::distributed::Vector&lt;float&gt;&gt;; </div><div class="line">  <span class="keyword">using</span> MatrixFreeActiveMatrix = <a class="code" href="classMatrixFreeOperators_1_1LaplaceOperator.html">MatrixFreeOperators::LaplaceOperator</a>&lt; </div><div class="line">    dim, </div><div class="line">    degree, </div><div class="line">    degree + 1, </div><div class="line">    1, </div><div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a>&gt;; </div><div class="line"></div><div class="line">  <span class="keyword">using</span> MatrixFreeLevelVector  = LinearAlgebra::distributed::Vector&lt;float&gt;; </div><div class="line">  <span class="keyword">using</span> MatrixFreeActiveVector = LinearAlgebra::distributed::Vector&lt;double&gt;; </div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> setup_system(); </div><div class="line">  <span class="keywordtype">void</span> setup_multigrid(); </div><div class="line">  <span class="keywordtype">void</span> assemble_system(); </div><div class="line">  <span class="keywordtype">void</span> assemble_multigrid(); </div><div class="line">  <span class="keywordtype">void</span> assemble_rhs(); </div><div class="line">  <span class="keywordtype">void</span> solve(); </div><div class="line">  <span class="keywordtype">void</span> estimate(); </div><div class="line">  <span class="keywordtype">void</span> refine_grid(); </div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> settings; </div><div class="line"></div><div class="line">  <a class="code" href="classMPI__Comm.html">MPI_Comm</a>           mpi_communicator; </div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout; </div><div class="line"></div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>; </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                                 fe; </div><div class="line"></div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler; </div><div class="line"></div><div class="line"> </div><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a>                  locally_relevant_dofs; </div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints; </div><div class="line"></div><div class="line">  MatrixType             system_matrix; </div><div class="line">  MatrixFreeActiveMatrix mf_system_matrix; </div><div class="line">  VectorType             solution; </div><div class="line">  VectorType             right_hand_side; </div><div class="line">  Vector&lt;double&gt;         estimated_error_square_per_cell; </div><div class="line"></div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixType&gt;</a> mg_matrix; </div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixType&gt;</a> mg_interface_in; </div><div class="line">  <a class="code" href="classMGConstrainedDoFs.html">MGConstrainedDoFs</a>         mg_constrained_dofs; </div><div class="line"></div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;MatrixFreeLevelMatrix&gt;</a> mf_mg_matrix; </div><div class="line"></div><div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a> computing_timer; </div><div class="line">}; </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line">LaplaceProblem&lt;dim, degree&gt;::LaplaceProblem(<span class="keyword">const</span> <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> &amp;settings) </div><div class="line">  : settings(settings) </div><div class="line">  , mpi_communicator(MPI_COMM_WORLD) </div><div class="line">  , pcout(<a class="code" href="namespacestd.html">std</a>::cout, (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)) </div><div class="line">  , triangulation(mpi_communicator, </div><div class="line">                  <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::limit_level_difference_at_vertices, </div><div class="line">                  (settings.solver == <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a>::amg) ? </div><div class="line">                    <a class="code" href="namespaceparallel.html">parallel</a>::distributed::<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::<a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0a7c2ea84f1b4c5f2a6aa010f600ca66b6">default_setting</a> : </div><div class="line">                    <a class="code" href="namespaceparallel.html">parallel</a>::distributed::<a class="code" href="classTriangulation.html">Triangulation</a>&lt; </div><div class="line">                      dim&gt;::<a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0acc0ed1c2dd30bca7c7576e65b4045274">construct_multigrid_hierarchy</a>) </div><div class="line">  , mapping() </div><div class="line">  , fe(degree) </div><div class="line">  , dof_handler(triangulation) </div><div class="line">  , computing_timer(pcout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::never, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times) </div><div class="line">{ </div><div class="line">  <a class="code" href="namespaceGridGenerator.html#a3b2a4ad8296c2b72a11d23b5969e8cc0">GridGenerator::hyper_L</a>(triangulation, -1., 1., <span class="comment">/*colorize*/</span> <span class="keyword">false</span>); </div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(1); </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::setup_system() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Setup&quot;</span>); </div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs); </div><div class="line">  locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(); </div><div class="line"></div><div class="line">  solution.reinit(locally_owned_dofs, mpi_communicator); </div><div class="line">  right_hand_side.reinit(locally_owned_dofs, mpi_communicator); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(locally_relevant_dofs); </div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>( </div><div class="line">    mapping, dof_handler, 0, <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(), constraints); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span> (settings.solver) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">        { </div><div class="line">          <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim, double&gt;::AdditionalData</a> additional_data; </div><div class="line">          additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> = </div><div class="line">            <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;::AdditionalData::none</a>; </div><div class="line">          additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#aa5d597e6c4441d273f4100b6139a2552">mapping_update_flags</a> = </div><div class="line">            (<a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>); </div><div class="line">          std::shared_ptr&lt;MatrixFree&lt;dim, double&gt;&gt; mf_storage = </div><div class="line">            std::make_shared&lt;MatrixFree&lt;dim, double&gt;&gt;(); </div><div class="line">          mf_storage-&gt;reinit(mapping, </div><div class="line">                             dof_handler, </div><div class="line">                             constraints, </div><div class="line">                             <a class="code" href="classQGauss.html">QGauss&lt;1&gt;</a>(degree + 1), </div><div class="line">                             additional_data); </div><div class="line"></div><div class="line">          mf_system_matrix.initialize(mf_storage); </div><div class="line"></div><div class="line">          <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">          mf_system_matrix.set_coefficient( </div><div class="line">            coefficient.make_coefficient_table(*mf_storage)); </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">      <span class="keywordflow">case</span> Settings::amg: </div><div class="line">        { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(locally_relevant_dofs); </div><div class="line">          <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, constraints); </div><div class="line"></div><div class="line">          <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(dsp, </div><div class="line">                                                     locally_owned_dofs, </div><div class="line">                                                     mpi_communicator, </div><div class="line">                                                     locally_relevant_dofs); </div><div class="line"></div><div class="line">          system_matrix.reinit(locally_owned_dofs, </div><div class="line">                               locally_owned_dofs, </div><div class="line">                               dsp, </div><div class="line">                               mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp(locally_owned_dofs, </div><div class="line">                                                locally_owned_dofs, </div><div class="line">                                                locally_relevant_dofs, </div><div class="line">                                                mpi_communicator); </div><div class="line">          <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, constraints); </div><div class="line">          dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">          system_matrix.reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line">    } </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::setup_multigrid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Setup multigrid&quot;</span>); </div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a9aed31323cbd7619edac310c47e7a7ad">distribute_mg_dofs</a>(); </div><div class="line"></div><div class="line">  mg_constrained_dofs.clear(); </div><div class="line">  mg_constrained_dofs.initialize(dof_handler); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::set&lt;types::boundary_id&gt; boundary_ids = {<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>(0)}; </div><div class="line">  mg_constrained_dofs.make_zero_boundary_constraints(dof_handler, boundary_ids); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_levels = triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span> (settings.solver) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">        { </div><div class="line">          mf_mg_matrix.resize(0, n_levels - 1); </div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            { </div><div class="line">              <a class="code" href="classIndexSet.html">IndexSet</a> relevant_dofs; </div><div class="line">              <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                            level, </div><div class="line">                                                            relevant_dofs); </div><div class="line">              <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> level_constraints; </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(relevant_dofs); </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#aef97b22281acb10c914d79a3881e2735">add_lines</a>( </div><div class="line">                mg_constrained_dofs.get_boundary_indices(level)); </div><div class="line">              level_constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line"></div><div class="line">              <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim, float&gt;::AdditionalData</a> additional_data; </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> = </div><div class="line">                <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, float&gt;::AdditionalData::none</a>; </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#aa5d597e6c4441d273f4100b6139a2552">mapping_update_flags</a> = </div><div class="line">                (<a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | </div><div class="line">                 <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>); </div><div class="line">              additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a67c9ff01c51fb7fb3ada151b83cdd409">mg_level</a> = <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>; </div><div class="line">              std::shared_ptr&lt;MatrixFree&lt;dim, float&gt;&gt; mf_storage_level( </div><div class="line">                <span class="keyword">new</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, float&gt;</a>()); </div><div class="line">              mf_storage_level-&gt;reinit(mapping, </div><div class="line">                                       dof_handler, </div><div class="line">                                       level_constraints, </div><div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;1&gt;</a>(degree + 1), </div><div class="line">                                       additional_data); </div><div class="line"></div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].initialize(mf_storage_level, </div><div class="line">                                             mg_constrained_dofs, </div><div class="line">                                             level); </div><div class="line"></div><div class="line">              <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].set_coefficient( </div><div class="line">                coefficient.make_coefficient_table(*mf_storage_level)); </div><div class="line"></div><div class="line">              mf_mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].compute_diagonal(); </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">        { </div><div class="line">          mg_matrix.resize(0, n_levels - 1); </div><div class="line">          mg_matrix.clear_elements(); </div><div class="line">          mg_interface_in.resize(0, n_levels - 1); </div><div class="line">          mg_interface_in.clear_elements(); </div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            { </div><div class="line">              <a class="code" href="classIndexSet.html">IndexSet</a> dof_set; </div><div class="line">              <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                            level, </div><div class="line">                                                            dof_set); </div><div class="line"></div><div class="line">              { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">                <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_set); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>( </div><div class="line">                  dsp, </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  mpi_communicator, </div><div class="line">                  dof_set); </div><div class="line"></div><div class="line">                mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dsp, </div><div class="line">                  mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">                <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_set, </div><div class="line">                  mpi_communicator); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line"></div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                mg_matrix[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">              } </div><div class="line"></div><div class="line">              { </div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">                <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_set); </div><div class="line">                <a class="code" href="namespaceMGTools.html#a8c677f65f8f1d21fb1f4c55cb90079e0">MGTools::make_interface_sparsity_pattern</a>(dof_handler, </div><div class="line">                                                         mg_constrained_dofs, </div><div class="line">                                                         dsp, </div><div class="line">                                                         level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>( </div><div class="line">                  dsp, </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  mpi_communicator, </div><div class="line">                  dof_set); </div><div class="line"></div><div class="line">                mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dsp, </div><div class="line">                  mpi_communicator); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">                <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> dsp( </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_handler.<a class="code" href="classDoFHandler.html#ac3c04582333686a8be6130df06929b35">locally_owned_mg_dofs</a>(level), </div><div class="line">                  dof_set, </div><div class="line">                  mpi_communicator); </div><div class="line"></div><div class="line">                <a class="code" href="namespaceMGTools.html#a8c677f65f8f1d21fb1f4c55cb90079e0">MGTools::make_interface_sparsity_pattern</a>(dof_handler, </div><div class="line">                                                         mg_constrained_dofs, </div><div class="line">                                                         dsp, </div><div class="line">                                                         level); </div><div class="line">                dsp.<a class="code" href="classDynamicSparsityPattern.html#a4ceb670be125dd2b8447e553374aa252">compress</a>(); </div><div class="line">                mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dsp); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line">              } </div><div class="line">            } </div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()); </div><div class="line">    } </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_system() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 1); </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, </div><div class="line">                          quadrature_formula, </div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); </div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell); </div><div class="line">  Vector&lt;double&gt;     cell_rhs(dofs_per_cell); </div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line">  RightHandSide&lt;dim&gt;     rhs; </div><div class="line">  std::vector&lt;double&gt;    rhs_values(n_q_points); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>()) </div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned()) </div><div class="line">      { </div><div class="line">        cell_matrix = 0; </div><div class="line">        cell_rhs    = 0; </div><div class="line"></div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient_value = </div><div class="line">          coefficient.average_value(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>()); </div><div class="line">        rhs.value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(), rhs_values); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">            { </div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) += </div><div class="line">                  coefficient_value *                <span class="comment">// epsilon(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_point) * <span class="comment">// * grad phi_i(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_point) * <span class="comment">// * grad phi_j(x) </span></div><div class="line">                  fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);            <span class="comment">// * dx </span></div><div class="line"></div><div class="line">              cell_rhs(i) += </div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_point) * <span class="comment">// grad phi_i(x) </span></div><div class="line">                rhs_values[q_point] *               <span class="comment">// * f(x) </span></div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point);             <span class="comment">// * dx </span></div><div class="line">            } </div><div class="line"></div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices); </div><div class="line">        constraints.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_matrix, </div><div class="line">                                               cell_rhs, </div><div class="line">                                               local_dof_indices, </div><div class="line">                                               system_matrix, </div><div class="line">                                               right_hand_side); </div><div class="line">      } </div><div class="line"></div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">  right_hand_side.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_multigrid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble multigrid&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 1); </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe, </div><div class="line">                          quadrature_formula, </div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>(); </div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell); </div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line"></div><div class="line">  std::vector&lt;AffineConstraints&lt;double&gt;&gt; boundary_constraints( </div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">    { </div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> dof_set; </div><div class="line">      <a class="code" href="namespaceDoFTools.html#a1fef7be07cf379b661646e39b9354e17">DoFTools::extract_locally_relevant_level_dofs</a>(dof_handler, </div><div class="line">                                                    level, </div><div class="line">                                                    dof_set); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(dof_set); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].add_lines( </div><div class="line">        mg_constrained_dofs.get_refinement_edge_indices(level)); </div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].add_lines( </div><div class="line">        mg_constrained_dofs.get_boundary_indices(level)); </div><div class="line"></div><div class="line">      boundary_constraints[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].close(); </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#ga7295c669f32e78c45446ddc236f19136">cell_iterators</a>()) </div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;level_subdomain_id() == triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>()) </div><div class="line">      { </div><div class="line">        cell_matrix = 0; </div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient_value = </div><div class="line">          coefficient.average_value(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>()); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) += </div><div class="line">                coefficient_value * fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_point) * </div><div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_point) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_point); </div><div class="line"></div><div class="line">        cell-&gt;get_mg_dof_indices(local_dof_indices); </div><div class="line"></div><div class="line">        boundary_constraints[cell-&gt;level()].distribute_local_to_global( </div><div class="line">          cell_matrix, local_dof_indices, mg_matrix[cell-&gt;level()]); </div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i) </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j) </div><div class="line">            <span class="keywordflow">if</span> (mg_constrained_dofs.is_interface_matrix_entry( </div><div class="line">                  cell-&gt;level(), local_dof_indices[i], local_dof_indices[j])) </div><div class="line">              mg_interface_in[cell-&gt;level()].add(local_dof_indices[i], </div><div class="line">                                                 local_dof_indices[j], </div><div class="line">                                                 <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j)); </div><div class="line">      } </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); ++i) </div><div class="line">    { </div><div class="line">      mg_matrix[i].compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">      mg_interface_in[i].compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line">    } </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::assemble_rhs() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Assemble right-hand side&quot;</span>); </div><div class="line"></div><div class="line">  MatrixFreeActiveVector solution_copy; </div><div class="line">  MatrixFreeActiveVector right_hand_side_copy; </div><div class="line">  mf_system_matrix.initialize_dof_vector(solution_copy); </div><div class="line">  mf_system_matrix.initialize_dof_vector(right_hand_side_copy); </div><div class="line"></div><div class="line">  solution_copy = 0.; </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution_copy); </div><div class="line">  solution_copy.update_ghost_values(); </div><div class="line">  right_hand_side_copy = 0; </div><div class="line">  <span class="keyword">const</span> <a class="code" href="classTable.html">Table&lt;2, VectorizedArray&lt;double&gt;</a>&gt; &amp;coefficient = </div><div class="line">    *(mf_system_matrix.get_coefficient()); </div><div class="line"></div><div class="line">  RightHandSide&lt;dim&gt; right_hand_side_function; </div><div class="line"></div><div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, degree, degree + 1, 1, double&gt;</a> phi( </div><div class="line">    *mf_system_matrix.get_matrix_free()); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; </div><div class="line">       cell &lt; mf_system_matrix.get_matrix_free()-&gt;n_cell_batches(); </div><div class="line">       ++cell) </div><div class="line">    { </div><div class="line">      phi.reinit(cell); </div><div class="line">      phi.read_dof_values_plain(solution_copy); </div><div class="line">      phi.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>); </div><div class="line"></div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; phi.n_q_points; ++q) </div><div class="line">        { </div><div class="line">          phi.submit_gradient(-1.0 * </div><div class="line">                                (coefficient(cell, 0) * phi.get_gradient(q)), </div><div class="line">                              q); </div><div class="line">          phi.submit_value( </div><div class="line">            right_hand_side_function.value(phi.quadrature_point(q)), q); </div><div class="line">        } </div><div class="line"></div><div class="line">      phi.integrate_scatter(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | </div><div class="line">                              <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>, </div><div class="line">                            right_hand_side_copy); </div><div class="line">    } </div><div class="line"></div><div class="line">  right_hand_side_copy.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(right_hand_side, right_hand_side_copy); </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::solve() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve&quot;</span>); </div><div class="line"></div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(1000, 1.e-10 * right_hand_side.l2_norm()); </div><div class="line">  solver_control.<a class="code" href="classSolverControl.html#a6d99741765243ccb65da4ff66558cf41">enable_history_data</a>(); </div><div class="line"></div><div class="line">  solution = 0.; </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span> (settings.solver) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mf: </div><div class="line">        { </div><div class="line">          computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">          <a class="code" href="classMGTransferMatrixFree.html">MGTransferMatrixFree&lt;dim, float&gt;</a> mg_transfer(mg_constrained_dofs); </div><div class="line">          mg_transfer.<a class="code" href="classMGTransferPrebuilt.html#a305c601c3f8c17c957a5ce71c95b933a">build</a>(dof_handler); </div><div class="line"></div><div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> coarse_solver_control(1000, 1e-12, <span class="keyword">false</span>, <span class="keyword">false</span>); </div><div class="line">          SolverCG&lt;MatrixFreeLevelVector&gt; coarse_solver(coarse_solver_control); </div><div class="line">          <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>            identity; </div><div class="line">          <a class="code" href="classMGCoarseGridIterativeSolver.html">MGCoarseGridIterativeSolver</a>&lt;MatrixFreeLevelVector, </div><div class="line">                                      SolverCG&lt;MatrixFreeLevelVector&gt;, </div><div class="line">                                      MatrixFreeLevelMatrix, </div><div class="line">                                      <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>&gt; </div><div class="line">            coarse_grid_solver(coarse_solver, mf_mg_matrix[0], identity); </div><div class="line"></div><div class="line">          <span class="keyword">using</span> Smoother = <a class="code" href="classPreconditionJacobi.html">::PreconditionJacobi&lt;MatrixFreeLevelMatrix&gt;</a>; </div><div class="line">          <a class="code" href="classMGSmootherPrecondition.html">MGSmootherPrecondition</a>&lt;MatrixFreeLevelMatrix, </div><div class="line">                                 Smoother, </div><div class="line">                                 MatrixFreeLevelVector&gt; </div><div class="line">            smoother; </div><div class="line">          smoother.<a class="code" href="classMGSmootherPrecondition.html#a3cb789b815bf6719eee79e2137c9bd84">initialize</a>(mf_mg_matrix, </div><div class="line">                              <span class="keyword">typename</span> Smoother::AdditionalData( </div><div class="line">                                settings.smoother_dampen)); </div><div class="line">          smoother.set_steps(settings.smoother_steps); </div><div class="line"></div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;MatrixFreeLevelVector&gt;</a> mg_m(mf_mg_matrix); </div><div class="line"></div><div class="line">          <a class="code" href="classMGLevelObject.html">MGLevelObject</a>&lt; </div><div class="line">            <a class="code" href="classMatrixFreeOperators_1_1MGInterfaceOperator.html">MatrixFreeOperators::MGInterfaceOperator&lt;MatrixFreeLevelMatrix&gt;</a>&gt; </div><div class="line">            mg_interface_matrices; </div><div class="line">          mg_interface_matrices.resize(0, triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() - 1); </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line">               ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            mg_interface_matrices[level].initialize(mf_mg_matrix[level]); </div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;MatrixFreeLevelVector&gt;</a> mg_interface(mg_interface_matrices); </div><div class="line"></div><div class="line">          <a class="code" href="classMultigrid.html">Multigrid&lt;MatrixFreeLevelVector&gt;</a> <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">            mg_m, coarse_grid_solver, mg_transfer, smoother, smoother); </div><div class="line">          <a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_interface, mg_interface); </div><div class="line"></div><div class="line">          <a class="code" href="classPreconditionMG.html">PreconditionMG</a>&lt;dim, </div><div class="line">                         MatrixFreeLevelVector, </div><div class="line">                         <a class="code" href="classMGTransferMatrixFree.html">MGTransferMatrixFree&lt;dim, float&gt;</a>&gt; </div><div class="line">            preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div><div class="line"></div><div class="line"></div><div class="line">          MatrixFreeActiveVector solution_copy; </div><div class="line">          MatrixFreeActiveVector right_hand_side_copy; </div><div class="line">          mf_system_matrix.initialize_dof_vector(solution_copy); </div><div class="line">          mf_system_matrix.initialize_dof_vector(right_hand_side_copy); </div><div class="line"></div><div class="line">          <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(solution_copy, solution); </div><div class="line">          <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(right_hand_side_copy, right_hand_side); </div><div class="line">          computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                                      <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">            preconditioner.vmult(solution_copy, right_hand_side_copy); </div><div class="line">          } </div><div class="line">          solution_copy = 0.; </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            <a class="code" href="classSolverCG.html">SolverCG&lt;MatrixFreeActiveVector&gt;</a> solver(solver_control); </div><div class="line"></div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">            solver.solve(mf_system_matrix, </div><div class="line">                         solution_copy, </div><div class="line">                         right_hand_side_copy, </div><div class="line">                         preconditioner); </div><div class="line">          } </div><div class="line"></div><div class="line">          solution_copy.update_ghost_values(); </div><div class="line">          <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">ChangeVectorTypes::copy</a>(solution, solution_copy); </div><div class="line">          constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::gmg_mb: </div><div class="line">        { </div><div class="line">          computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">          <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;VectorType&gt;</a> mg_transfer(mg_constrained_dofs); </div><div class="line">          mg_transfer.<a class="code" href="classMGTransferPrebuilt.html#a305c601c3f8c17c957a5ce71c95b933a">build</a>(dof_handler); </div><div class="line"></div><div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a>        coarse_solver_control(1000, 1e-12, <span class="keyword">false</span>, <span class="keyword">false</span>); </div><div class="line">          SolverCG&lt;VectorType&gt; coarse_solver(coarse_solver_control); </div><div class="line">          <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a> identity; </div><div class="line">          <a class="code" href="classMGCoarseGridIterativeSolver.html">MGCoarseGridIterativeSolver</a>&lt;VectorType, </div><div class="line">                                      SolverCG&lt;VectorType&gt;, </div><div class="line">                                      MatrixType, </div><div class="line">                                      <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a>&gt; </div><div class="line">            coarse_grid_solver(coarse_solver, mg_matrix[0], identity); </div><div class="line"></div><div class="line">          <span class="keyword">using</span> Smoother = <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a84fd288bacabd1a7e3408885fb0fad01">LA::MPI::PreconditionJacobi</a>; </div><div class="line">          <a class="code" href="classMGSmootherPrecondition.html">MGSmootherPrecondition&lt;MatrixType, Smoother, VectorType&gt;</a> smoother; </div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          smoother.<a class="code" href="classMGSmootherPrecondition.html#a3cb789b815bf6719eee79e2137c9bd84">initialize</a>(mg_matrix); </div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>( </div><div class="line">            settings.smoother_dampen == 1.0, </div><div class="line">            <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>( </div><div class="line">              <span class="stringliteral">&quot;PETSc&#39;s PreconditionJacobi has no support for a damping parameter.&quot;</span>)); </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          smoother.<a class="code" href="classMGSmootherPrecondition.html#a3cb789b815bf6719eee79e2137c9bd84">initialize</a>(mg_matrix, settings.smoother_dampen); </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          smoother.<a class="code" href="classMGSmoother.html#a9976182b6b272aac7800a8fbf18c8ab9">set_steps</a>(settings.smoother_steps); </div><div class="line"></div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_m(mg_matrix); </div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_in(mg_interface_in); </div><div class="line">          <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;VectorType&gt;</a> mg_out(mg_interface_in); </div><div class="line"></div><div class="line">          <a class="code" href="classMultigrid.html">Multigrid&lt;VectorType&gt;</a> <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">            mg_m, coarse_grid_solver, mg_transfer, smoother, smoother); </div><div class="line">          <a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_out, mg_in); </div><div class="line"></div><div class="line">          <a class="code" href="classPreconditionMG.html">PreconditionMG&lt;dim, VectorType, MGTransferPrebuilt&lt;VectorType&gt;</a>&gt; </div><div class="line">            preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div><div class="line"></div><div class="line">          computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                                      <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">            preconditioner.vmult(solution, right_hand_side); </div><div class="line">          } </div><div class="line">          solution = 0.; </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            SolverCG&lt;VectorType&gt; solver(solver_control); </div><div class="line"></div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">            solver.solve(system_matrix, </div><div class="line">                         solution, </div><div class="line">                         right_hand_side, </div><div class="line">                         preconditioner); </div><div class="line">          } </div><div class="line"></div><div class="line">          constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line"> </div><div class="line">        } </div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">case</span> Settings::amg: </div><div class="line">        { </div><div class="line">          computing_timer.enter_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">PreconditionAMG</a>                 preconditioner; </div><div class="line">          PreconditionAMG::AdditionalData Amg_data; </div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA </span></div><div class="line">          Amg_data.symmetric_operator = <span class="keyword">true</span>; </div><div class="line"><span class="preprocessor">#else </span></div><div class="line">          Amg_data.elliptic              = <span class="keyword">true</span>; </div><div class="line">          Amg_data.smoother_type         = <span class="stringliteral">&quot;Jacobi&quot;</span>; </div><div class="line">          Amg_data.higher_order_elements = <span class="keyword">true</span>; </div><div class="line">          Amg_data.smoother_sweeps       = settings.smoother_steps; </div><div class="line">          Amg_data.aggregation_threshold = 0.02; </div><div class="line"><span class="preprocessor">#endif </span></div><div class="line"></div><div class="line">          Amg_data.output_details = <span class="keyword">false</span>; </div><div class="line"></div><div class="line">          preconditioner.initialize(system_matrix, Amg_data); </div><div class="line">          computing_timer.leave_subsection(<span class="stringliteral">&quot;Solve: Preconditioner setup&quot;</span>); </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, </div><div class="line">                                      <span class="stringliteral">&quot;Solve: 1 multigrid V-cycle&quot;</span>); </div><div class="line">            preconditioner.vmult(solution, right_hand_side); </div><div class="line">          } </div><div class="line">          solution = 0.; </div><div class="line"></div><div class="line"></div><div class="line">          { </div><div class="line">            SolverCG&lt;VectorType&gt; solver(solver_control); </div><div class="line"></div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Solve: CG&quot;</span>); </div><div class="line">            solver.solve(system_matrix, </div><div class="line">                         solution, </div><div class="line">                         right_hand_side, </div><div class="line">                         preconditioner); </div><div class="line">          } </div><div class="line">          constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line"></div><div class="line">          <span class="keywordflow">break</span>; </div><div class="line">        } </div><div class="line"></div><div class="line">      <span class="keywordflow">default</span>: </div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>()); </div><div class="line">    } </div><div class="line"></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Number of CG iterations:      &quot;</span> &lt;&lt; solver_control.last_step() </div><div class="line">        &lt;&lt; std::endl; </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">struct </span>ScratchData </div><div class="line">{ </div><div class="line">  ScratchData(<span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      mapping, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe, </div><div class="line">              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        quadrature_degree, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags, </div><div class="line">              <span class="keyword">const</span> <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         interface_update_flags) </div><div class="line">    : fe_values(mapping, fe, <a class="code" href="classQGauss.html">QGauss</a>&lt;dim&gt;(quadrature_degree), update_flags) </div><div class="line">    , fe_interface_values(mapping, </div><div class="line">                          fe, </div><div class="line">                          <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt;(quadrature_degree), </div><div class="line">                          interface_update_flags) </div><div class="line">  {} </div><div class="line"></div><div class="line">  ScratchData(<span class="keyword">const</span> ScratchData&lt;dim&gt; &amp;scratch_data) </div><div class="line">    : fe_values(scratch_data.fe_values.get_mapping(), </div><div class="line">                scratch_data.fe_values.get_fe(), </div><div class="line">                scratch_data.fe_values.get_quadrature(), </div><div class="line">                scratch_data.fe_values.get_update_flags()) </div><div class="line">    , fe_interface_values(scratch_data.fe_values.get_mapping(), </div><div class="line">                          scratch_data.fe_values.get_fe(), </div><div class="line">                          scratch_data.fe_interface_values.get_quadrature(), </div><div class="line">                          scratch_data.fe_interface_values.get_update_flags()) </div><div class="line">  {} </div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>          fe_values; </div><div class="line">  <a class="code" href="classFEInterfaceValues.html">FEInterfaceValues&lt;dim&gt;</a> fe_interface_values; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">struct </span>CopyData </div><div class="line">{ </div><div class="line">  CopyData() </div><div class="line">    : <a class="code" href="grid__tools_8cc.html#aff11e57deb99b39b7d7d26cf866798f2">cell_index</a>(<a class="code" href="namespacenumbers.html">numbers</a>::<a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">invalid_unsigned_int</a>) </div><div class="line">    , value(0.) </div><div class="line">  {} </div><div class="line"></div><div class="line">  CopyData(<span class="keyword">const</span> CopyData &amp;) = <span class="keywordflow">default</span>; </div><div class="line"></div><div class="line">  <span class="keyword">struct </span>FaceData </div><div class="line">  { </div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_indices[2]; </div><div class="line">    <span class="keywordtype">double</span>       values[2]; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          <a class="code" href="grid__tools_8cc.html#aff11e57deb99b39b7d7d26cf866798f2">cell_index</a>; </div><div class="line">  <span class="keywordtype">double</span>                value; </div><div class="line">  std::vector&lt;FaceData&gt; face_data; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::estimate() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Estimate&quot;</span>); </div><div class="line"></div><div class="line">  VectorType temp_solution; </div><div class="line">  temp_solution.reinit(locally_owned_dofs, </div><div class="line">                       locally_relevant_dofs, </div><div class="line">                       mpi_communicator); </div><div class="line">  temp_solution = solution; </div><div class="line"></div><div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient; </div><div class="line"></div><div class="line">  estimated_error_square_per_cell.reinit(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line"></div><div class="line">  <span class="keyword">using</span> Iterator = <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a>; </div><div class="line"></div><div class="line">  <span class="keyword">auto</span> cell_worker = [&amp;](<span class="keyword">const</span> Iterator &amp;  cell, </div><div class="line">                         ScratchData&lt;dim&gt; &amp;scratch_data, </div><div class="line">                         CopyData &amp;        copy_data) { </div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;fe_values = scratch_data.fe_values; </div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell); </div><div class="line"></div><div class="line">    RightHandSide&lt;dim&gt; rhs; </div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       rhs_value = rhs.value(cell-&gt;center()); </div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> nu = coefficient.value(cell-&gt;center()); </div><div class="line"></div><div class="line"> </div><div class="line">    fe_values.<a class="code" href="classFEValuesBase.html#ae8f183c9d6da0c7daf9d345e0bc91b0a">get_function_hessians</a>(temp_solution, <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaccf663e018d31c264b769c80bd91db4d">hessians</a>); </div><div class="line"></div><div class="line">    copy_data.cell_index = cell-&gt;active_cell_index(); </div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> residual_norm_square = 0.; </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> k = 0; k &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++k) </div><div class="line">      { </div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> residual = (rhs_value + nu * <a class="code" href="symmetric__tensor_8h.html#a4248760c880275bab1f288fc80f27039">trace</a>(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaccf663e018d31c264b769c80bd91db4d">hessians</a>[k])); </div><div class="line">        residual_norm_square += residual * residual * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(k); </div><div class="line">      } </div><div class="line"></div><div class="line">    copy_data.value = </div><div class="line">      cell-&gt;diameter() * cell-&gt;diameter() * residual_norm_square; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keyword">auto</span> face_worker = [&amp;](<span class="keyword">const</span> Iterator &amp;    cell, </div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;f, </div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;sf, </div><div class="line">                         <span class="keyword">const</span> Iterator &amp;    ncell, </div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;nf, </div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;nsf, </div><div class="line">                         ScratchData&lt;dim&gt; &amp;  scratch_data, </div><div class="line">                         CopyData &amp;          copy_data) { </div><div class="line">    <a class="code" href="classFEInterfaceValues.html">FEInterfaceValues&lt;dim&gt;</a> &amp;fe_interface_values = </div><div class="line">      scratch_data.fe_interface_values; </div><div class="line">    fe_interface_values.<a class="code" href="classFEInterfaceValues.html#af6aa20b6652c2605d4cee36021f6bcd2">reinit</a>(cell, f, sf, ncell, nf, nsf); </div><div class="line"></div><div class="line">    copy_data.face_data.emplace_back(); </div><div class="line">    CopyData::FaceData &amp;copy_data_face = copy_data.face_data.back(); </div><div class="line"></div><div class="line">    copy_data_face.cell_indices[0] = cell-&gt;active_cell_index(); </div><div class="line">    copy_data_face.cell_indices[1] = ncell-&gt;active_cell_index(); </div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> coeff1 = coefficient.value(cell-&gt;center()); </div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> coeff2 = coefficient.value(ncell-&gt;center()); </div><div class="line"></div><div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_u[2]; </div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 2; ++i) </div><div class="line">      { </div><div class="line">        grad_u[i].resize(fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a41f6734be1313f750fa8b3b7ba470f35">n_quadrature_points</a>); </div><div class="line">        fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a6ac7ddd5ac77cc4a1925ec5f0b100bf2">get_fe_face_values</a>(i).get_function_gradients( </div><div class="line">          temp_solution, grad_u[i]); </div><div class="line">      } </div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> jump_norm_square = 0.; </div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> qpoint = 0; </div><div class="line">         qpoint &lt; fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a41f6734be1313f750fa8b3b7ba470f35">n_quadrature_points</a>; </div><div class="line">         ++qpoint) </div><div class="line">      { </div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> jump = </div><div class="line">          coeff1 * grad_u[0][qpoint] * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a1a52fcfa2f54f153cc7cdda3788e5ac0">normal</a>(qpoint) - </div><div class="line">          coeff2 * grad_u[1][qpoint] * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a1a52fcfa2f54f153cc7cdda3788e5ac0">normal</a>(qpoint); </div><div class="line"></div><div class="line">        jump_norm_square += jump * jump * fe_interface_values.<a class="code" href="classFEInterfaceValues.html#a9f8f06f7da061e1c2a20c5cc68a89db1">JxW</a>(qpoint); </div><div class="line">      } </div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> h           = cell-&gt;face(f)-&gt;measure(); </div><div class="line">    copy_data_face.values[0] = 0.5 * h * jump_norm_square; </div><div class="line">    copy_data_face.values[1] = copy_data_face.values[0]; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keyword">auto</span> copier = [&amp;](<span class="keyword">const</span> CopyData &amp;copy_data) { </div><div class="line">    <span class="keywordflow">if</span> (copy_data.cell_index != <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>) </div><div class="line">      estimated_error_square_per_cell[copy_data.cell_index] += copy_data.value; </div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;cdf : copy_data.face_data) </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; 2; ++j) </div><div class="line">        estimated_error_square_per_cell[cdf.cell_indices[j]] += cdf.values[j]; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_gauss_points = degree + 1; </div><div class="line">  ScratchData&lt;dim&gt;   scratch_data(mapping, </div><div class="line">                                fe, </div><div class="line">                                n_gauss_points, </div><div class="line">                                <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | </div><div class="line">                                  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>, </div><div class="line">                                <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | </div><div class="line">                                  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>); </div><div class="line">  CopyData           copy_data; </div><div class="line"></div><div class="line"></div><div class="line">  <a class="code" href="group__MeshWorker.html#ga76ec61fbd188fb320fe8ca166a79b322">MeshWorker::mesh_loop</a>(dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(), </div><div class="line">                        dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>(), </div><div class="line">                        cell_worker, </div><div class="line">                        copier, </div><div class="line">                        scratch_data, </div><div class="line">                        copy_data, </div><div class="line">                        <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa44a76e905b1d4cd80af387b5fac4d8aa">MeshWorker::assemble_own_cells</a> | </div><div class="line">                          <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa9396964e7e270fe0a0c5d01474721c24">MeshWorker::assemble_ghost_faces_both</a> | </div><div class="line">                          <a class="code" href="namespaceMeshWorker.html#ac7a9db8b34d398d7d398d1e8809874aaa47c6806a06155c94191629fae2755763">MeshWorker::assemble_own_interior_faces_once</a>, </div><div class="line">                          <span class="comment">/*boundary_worker=*/</span><span class="keyword">nullptr</span>, face_worker);</div><div class="line"></div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_error_estimate = </div><div class="line">    <a class="code" href="vectorization_8h.html#a303f564e3c189251976da401ee2e44fa">std::sqrt</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a>(estimated_error_square_per_cell.l1_norm(), </div><div class="line">                                  mpi_communicator)); </div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Global error estimate:        &quot;</span> &lt;&lt; global_error_estimate </div><div class="line">        &lt;&lt; std::endl; </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::refine_grid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Refine grid&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> refinement_fraction = 1. / (<a class="code" href="vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2.0, dim) - 1.); </div><div class="line">  <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>( </div><div class="line">    triangulation, estimated_error_square_per_cell, refinement_fraction, 0.0); </div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>(); </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim, degree&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) </div><div class="line">{ </div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing(computing_timer, <span class="stringliteral">&quot;Output results&quot;</span>); </div><div class="line"></div><div class="line">  VectorType temp_solution; </div><div class="line">  temp_solution.reinit(locally_owned_dofs, </div><div class="line">                       locally_relevant_dofs, </div><div class="line">                       mpi_communicator); </div><div class="line">  temp_solution = solution; </div><div class="line"></div><div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out; </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temp_solution, <span class="stringliteral">&quot;solution&quot;</span>); </div><div class="line"></div><div class="line">  Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i) </div><div class="line">    subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>(); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>); </div><div class="line"></div><div class="line">  Vector&lt;float&gt; <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>()); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : triangulation.<a class="code" href="group__CPP11.html#ga4288670ae5bd80367e24918d542cb2d8">active_cell_iterators</a>()) </div><div class="line">    <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>(cell-&gt;active_cell_index()) = cell-&gt;level(); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(level, <span class="stringliteral">&quot;level&quot;</span>); </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (estimated_error_square_per_cell.size() &gt; 0) </div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(estimated_error_square_per_cell, </div><div class="line">                             <span class="stringliteral">&quot;estimated_error_square_per_cell&quot;</span>); </div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::string pvtu_filename = data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>( </div><div class="line">    <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2 <span class="comment">/*n_digits*/</span>, 1 <span class="comment">/*n_groups*/</span>); </div><div class="line"></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Wrote &quot;</span> &lt;&lt; pvtu_filename &lt;&lt; std::endl; </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> degree&gt; </div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">LaplaceProblem&lt;dim, degree&gt;::run</a>() </div><div class="line">{ </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; settings.n_steps; ++cycle) </div><div class="line">    { </div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">if</span> (cycle &gt; 0) </div><div class="line">        refine_grid(); </div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span> </div><div class="line">            &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#a584733c8499dbd140694bfe04e0963ca">n_global_active_cells</a>(); </div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">          settings.solver == Settings::gmg_mb) </div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() &lt;&lt; <span class="stringliteral">&quot; global levels)&quot;</span> </div><div class="line">              &lt;&lt; std::endl </div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;   Partition efficiency:         &quot;</span> </div><div class="line">              &lt;&lt; 1.0 / <a class="code" href="namespaceMGTools.html#a8776ac550d9ac85e7e0db51625935673">MGTools::workload_imbalance</a>(triangulation); </div><div class="line">      pcout &lt;&lt; std::endl; </div><div class="line"></div><div class="line">      setup_system(); </div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">          settings.solver == Settings::gmg_mb) </div><div class="line">        setup_multigrid(); </div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(); </div><div class="line">      <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf || </div><div class="line">          settings.solver == Settings::gmg_mb) </div><div class="line">        { </div><div class="line">          pcout &lt;&lt; <span class="stringliteral">&quot; (by level: &quot;</span>; </div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>(); </div><div class="line">               ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">            pcout &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level) </div><div class="line">                  &lt;&lt; (level == triangulation.<a class="code" href="classTriangulation.html#aafd960d483675c4eb2c538529350e56b">n_global_levels</a>() - 1 ? <span class="stringliteral">&quot;)&quot;</span> : </div><div class="line">                                                                     <span class="stringliteral">&quot;, &quot;</span>); </div><div class="line">        } </div><div class="line">      pcout &lt;&lt; std::endl; </div><div class="line"></div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mf) </div><div class="line">        assemble_rhs(); </div><div class="line">      <span class="keywordflow">else</span> <span class="comment">/*gmg_mb or amg*/</span> </div><div class="line">        { </div><div class="line">          assemble_system(); </div><div class="line">          <span class="keywordflow">if</span> (settings.solver == Settings::gmg_mb) </div><div class="line">            assemble_multigrid(); </div><div class="line">        } </div><div class="line"></div><div class="line">      solve(); </div><div class="line">      estimate(); </div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (settings.output) </div><div class="line">        output_results(cycle); </div><div class="line"></div><div class="line">      computing_timer.print_summary(); </div><div class="line">      computing_timer.reset(); </div><div class="line">    } </div><div class="line">} </div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) </div><div class="line">{ </div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div><div class="line">  <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1); </div><div class="line"></div><div class="line">  <a class="code" href="namespaceTriangulationDescription.html#aa1531298eb0a267d9ceca5eb46ada8e0">Settings</a> settings; </div><div class="line">  <span class="keywordflow">if</span> (!settings.try_parse((argc &gt; 1) ? (argv[1]) : <span class="stringliteral">&quot;&quot;</span>)) </div><div class="line">    <span class="keywordflow">return</span> 0; </div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree = 2; </div><div class="line"></div><div class="line">      <span class="keywordflow">switch</span> (settings.dimension) </div><div class="line">        { </div><div class="line">          <span class="keywordflow">case</span> 2: </div><div class="line">            { </div><div class="line">              LaplaceProblem&lt;2, fe_degree&gt; test(settings); </div><div class="line">              test.run(); </div><div class="line"></div><div class="line">              <span class="keywordflow">break</span>; </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">case</span> 3: </div><div class="line">            { </div><div class="line">              LaplaceProblem&lt;3, fe_degree&gt; test(settings); </div><div class="line">              test.run(); </div><div class="line"></div><div class="line">              <span class="keywordflow">break</span>; </div><div class="line">            } </div><div class="line"></div><div class="line">          <span class="keywordflow">default</span>: </div><div class="line">            <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;This program only works in 2d and 3d.&quot;</span>)); </div><div class="line">        } </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      MPI_Abort(MPI_COMM_WORLD, 1); </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (...) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      MPI_Abort(MPI_COMM_WORLD, 2); </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0; </div><div class="line">} </div><div class="line"></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
