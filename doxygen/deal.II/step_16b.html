<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_16b.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-16b tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-16b tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_16.html">step-16</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Thetestcase">The testcase</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Theintegratoroneachcell">The integrator on each cell</a>
        <li><a href="#ThecodeLaplaceProblemcodeclasstemplate">The <code>LaplaceProblem</code> class template</a>
        <li><a href="#ThecodeLaplaceProblemcodeclassimplementation">The <code>LaplaceProblem</code> class implementation</a>
      <ul>
        <li><a href="#LaplaceProblemsetup_system">LaplaceProblem::setup_system</a>
        <li><a href="#LaplaceProblemassemble_system">LaplaceProblem::assemble_system</a>
        <li><a href="#LaplaceProblemassemble_multigrid">LaplaceProblem::assemble_multigrid</a>
        <li><a href="#LaplaceProblemsolve">LaplaceProblem::solve</a>
        <li><a href="#Postprocessing">Postprocessing</a>
        <li><a href="#LaplaceProblemrun">LaplaceProblem::run</a>
      </ul>
        <li><a href="#Themainfunction">The main() function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 examples/step-16b/doc/intro.dox</p>
<p><br />
</p>
<p><a class="anchor" id="Intro"></a></p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>这是第16步的一个变体，唯一的变化是我们使用MeshWorker框架和预制的LocalIntegrator辅助类，而不是手动组装矩阵。</p>
<p>关于这个框架在实践中如何使用的细节，将作为本教程计划的一部分加以解释。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>我们在这里解决的问题与步骤16中的问题相同。</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>同样，前几个include文件已经知道了，所以我们不会对它们进行评论。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span> </div></div><!-- fragment --><p>这些，现在，是多级方法所必需的包括。第一个声明了如何处理多网格方法每个层次上的Dirichlet边界条件。对于自由度的实际描述，我们不需要任何新的包含文件，因为DoFHandler已经实现了所有必要的方法。我们只需要将自由度分配给更多的层次。</p>
<p>其余的包含文件涉及到作为线性算子（求解器或预处理器）的多重网格的力学问题。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__constrained__dofs_8h.html">deal.II/multigrid/mg_constrained_dofs.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="multigrid_8h.html">deal.II/multigrid/multigrid.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer_8h.html">deal.II/multigrid/mg_transfer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__tools_8h.html">deal.II/multigrid/mg_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__coarse_8h.html">deal.II/multigrid/mg_coarse.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__smoother_8h.html">deal.II/multigrid/mg_smoother.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__matrix_8h.html">deal.II/multigrid/mg_matrix.h</a>&gt;</span> </div></div><!-- fragment --><p>最后我们包括MeshWorker框架。这个框架通过其函数loop()和integration_loop()，自动在单元格上进行循环，并将数据组装成向量、矩阵等。它自动服从约束。由于我们必须建立几个矩阵，并且必须注意几组约束，这将使我们省去很多麻烦。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="meshworker_2dof__info_8h.html">deal.II/meshworker/dof_info.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="integration__info_8h.html">deal.II/meshworker/integration_info.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="simple_8h.html">deal.II/meshworker/simple.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="output_8h.html">deal.II/meshworker/output.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="loop_8h.html">deal.II/meshworker/loop.h</a>&gt;</span> </div></div><!-- fragment --><p>为了节省精力，我们使用了在以下文件中找到的预先实现的拉普拉斯。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="laplace_8h.html">deal.II/integrators/laplace.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="l2_8h.html">deal.II/integrators/l2.h</a>&gt;</span> </div></div><!-- fragment --><p>这就是C++。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span> </div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step16 </div><div class="line">{ </div></div><!-- fragment --><p><a class="anchor" id="Theintegratoroneachcell"></a> </p><h3>The integrator on each cell</h3>
<p><a class="el" href="group__MeshWorker.html#ga93cfb35f7969ce8f0be7628255dfe7fb">MeshWorker::integration_loop()</a> 希望有一个类能够提供在单元格和边界及内部面的积分功能。这是由下面的类来完成的。在构造函数中，我们告诉循环应该计算单元格积分（"真"），但不应该计算边界和内部面的积分（两个 "假"）。因此，我们只需要一个单元格函数，而不需要面的函数。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>LaplaceIntegrator : <span class="keyword">public</span> <a class="code" href="classMeshWorker_1_1LocalIntegrator.html">MeshWorker::LocalIntegrator</a>&lt;dim&gt; </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  LaplaceIntegrator(); </div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classMeshWorker_1_1LocalIntegrator.html#a44cc05e3e905a8cd5af4c12d3026ea2a">cell</a>(MeshWorker::DoFInfo&lt;dim&gt; &amp;        dinfo, </div><div class="line">                    <a class="code" href="classMeshWorker_1_1IntegrationInfo.html">MeshWorker::IntegrationInfo&lt;dim&gt;</a> &amp;info) <span class="keyword">const override</span>; </div><div class="line">}; </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">LaplaceIntegrator&lt;dim&gt;::LaplaceIntegrator() </div><div class="line">  : <a class="code" href="namespaceMeshWorker.html">MeshWorker</a>::LocalIntegrator&lt;dim&gt;(true, false, false) </div><div class="line">{} </div></div><!-- fragment --><p>接下来是每个单元上的实际积分器。我们解决一个泊松问题，在右半平面上的系数为1，在左半平面上的系数为十分之一。</p>
<p><a class="el" href="classMeshWorker_1_1LocalResults.html">MeshWorker::LocalResults</a> 的基类 <a class="el" href="classMeshWorker_1_1DoFInfo.html">MeshWorker::DoFInfo</a> 包含可以在这个局部积分器中填充的对象。在MeshWorker框架内，有多少对象被创建是由装配器类决定的。在这里，我们举例测试一下，需要一个矩阵 (<a class="el" href="classMeshWorker_1_1LocalResults.html#ac63bee72524d6f8c064b23e3ccb576af">MeshWorker::LocalResults::n_matrices()</a>). 矩阵是通过 <a class="el" href="classMeshWorker_1_1LocalResults.html#a06c5d817ce47a4c26966df1cdcebeac4">MeshWorker::LocalResults::matrix()</a>, 来访问的，它的第一个参数是矩阵的编号。第二个参数只用于面的积分，当每个测试函数使用两个矩阵时。那么，第二个指标为 "true "的矩阵将以相同的索引存在。</p>
<p><a class="el" href="classMeshWorker_1_1IntegrationInfo.html">MeshWorker::IntegrationInfo</a> 提供了一个或几个FEValues对象，下面这些对象被 <a class="el" href="namespaceLocalIntegrators_1_1Laplace.html#a733b581e72bfe9d27cc59501a35bcd30">LocalIntegrators::Laplace::cell_matrix()</a> 或 <a class="el" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">LocalIntegrators::L2::L2()</a>. 使用，因为我们只组装一个PDE，所以也只有一个索引为0的对象。</p>
<p>此外，我们注意到这个积分器的作用是计算多级预处理的矩阵，以及全局系统的矩阵和右手边。由于系统的汇编器需要一个额外的向量， <a class="el" href="classMeshWorker_1_1LocalResults.html#a18a21989c69233694473c643d44df24f">MeshWorker::LocalResults::n_vectors()</a> 要返回一个非零值。相应地，我们在这个函数的末尾填充了一个右边的向量。由于LocalResults可以处理多个BlockVector对象，但我们这里又是最简单的情况，所以我们将信息输入到零号向量的零号块中。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> </div><div class="line">LaplaceIntegrator&lt;dim&gt;::cell(MeshWorker::DoFInfo&lt;dim&gt; &amp;        dinfo, </div><div class="line">                             <a class="code" href="classMeshWorker_1_1IntegrationInfo.html">MeshWorker::IntegrationInfo&lt;dim&gt;</a> &amp;info)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#ac63bee72524d6f8c064b23e3ccb576af">n_matrices</a>(), 1); </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient = (dinfo.<a class="code" href="classMeshWorker_1_1DoFInfo.html#acdb25148428f90647ca6c6166e212ffa">cell</a>-&gt;center()(0) &gt; 0.) ? .1 : 1.; </div><div class="line"></div><div class="line">  <a class="code" href="namespaceLocalIntegrators_1_1Laplace.html#a733b581e72bfe9d27cc59501a35bcd30">LocalIntegrators::Laplace::cell_matrix</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a06c5d817ce47a4c26966df1cdcebeac4">matrix</a>(0, <span class="keyword">false</span>).matrix, </div><div class="line">                                         info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0), </div><div class="line">                                         coefficient); </div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a18a21989c69233694473c643d44df24f">n_vectors</a>() &gt; 0) </div><div class="line">    { </div><div class="line">      std::vector&lt;double&gt; rhs(info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0).n_quadrature_points, 1.); </div><div class="line">      <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">LocalIntegrators::L2::L2</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a13d325f993aa366ce5f837f37d96a90b">vector</a>(0).block(0), </div><div class="line">                               info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0), </div><div class="line">                               rhs); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="ThecodeLaplaceProblemcodeclasstemplate"></a> </p><h3>The <code>LaplaceProblem</code> class template</h3>
<p>这个主类与 <a class="el" href="step_6.html">step-6</a> 中的类基本相同。就成员函数而言，唯一增加的是 <code>assemble_multigrid</code> 函数，它组装了对应于中间层离散运算符的矩阵。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keyword">class </span>LaplaceProblem </div><div class="line">{ </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  LaplaceProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree); </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>(); </div><div class="line"></div><div class="line"><span class="keyword">private</span>: </div><div class="line">  <span class="keywordtype">void</span> setup_system(); </div><div class="line">  <span class="keywordtype">void</span> assemble_system(); </div><div class="line">  <span class="keywordtype">void</span> assemble_multigrid(); </div><div class="line">  <span class="keywordtype">void</span> solve(); </div><div class="line">  <span class="keywordtype">void</span> refine_grid(); </div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>; </div><div class="line"></div><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>; </div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe; </div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler; </div><div class="line"></div><div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern; </div><div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix; </div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints; </div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution; </div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs; </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree; </div></div><!-- fragment --><p>以下成员是多网格方法的基本数据结构。前两个表示稀疏模式和多级层次结构中各个层次的矩阵，非常类似于上面的全局网格的对象。</p>
<p>然后，我们有两个新的矩阵，只需要在自适应网格上进行局部平滑的多网格方法。它们在细化区域的内部和细化边缘之间传递数据，在 <a class="el" href="DEALGlossary.html#mg_paper">多网格论文 </a>中详细介绍过。</p>
<p>最后一个对象存储了每个层次上的边界指数信息和位于两个不同细化层次之间的细化边缘上的指数信息。因此，它的作用与AffineConstraints类似，但在每个层次上。</p>
<div class="fragment"><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparsityPattern&gt;</a>      mg_sparsity_patterns; </div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_matrices; </div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_interface_in; </div><div class="line">  <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_interface_out; </div><div class="line">  <a class="code" href="classMGConstrainedDoFs.html">MGConstrainedDoFs</a>                   mg_constrained_dofs; </div><div class="line">}; </div></div><!-- fragment --><p><a class="anchor" id="ThecodeLaplaceProblemcodeclassimplementation"></a> </p><h3>The <code>LaplaceProblem</code> class implementation</h3>
<p>关于三角形的构造函数只有一个简短的评论：按照惯例，deal.II中所有自适应精化的三角形在单元格之间的面的变化不会超过一个级别。然而，对于我们的多网格算法，我们需要一个更严格的保证，即网格在连接两个单元的顶点上的变化也不超过细化级别。换句话说，我们必须防止出现以下情况。</p>
<div class="image">
<img src="limit_level_difference_at_vertices.png" alt="limit_level_difference_at_vertices.png"/>
</div>
<p>这可以通过向三角化类的构造函数传递 <a class="el" href="classTriangulation.html#a0633dd17e535a59162b79f338c6ff5aeaa2ab57e4f7b1633f26092ae861ea3bfc">Triangulation::limit_level_difference_at_vertices</a> 标志来实现。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">LaplaceProblem&lt;dim&gt;::LaplaceProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree) </div><div class="line">  : triangulation(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::limit_level_difference_at_vertices) </div><div class="line">  , fe(degree) </div><div class="line">  , dof_handler(triangulation) </div><div class="line">  , degree(degree) </div><div class="line">{} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemsetup_system"></a> </p><h4>LaplaceProblem::setup_system</h4>
<p>除了只是在DoFHandler中分配自由度之外，我们在每一层都做同样的事情。然后，我们按照之前的程序，在叶子网格上设置系统。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::setup_system() </div><div class="line">{ </div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe); </div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a9aed31323cbd7619edac310c47e7a7ad">distribute_mg_dofs</a>(); </div><div class="line"></div><div class="line">  <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() </div><div class="line">          &lt;&lt; <span class="stringliteral">&quot; (by level: &quot;</span>; </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.n_levels(); ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">    <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level) </div><div class="line">            &lt;&lt; (level == triangulation.n_levels() - 1 ? <span class="stringliteral">&quot;)&quot;</span> : <span class="stringliteral">&quot;, &quot;</span>); </div><div class="line">  <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; std::endl; </div><div class="line"></div><div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(), dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp); </div><div class="line"></div><div class="line">  solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line">  system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line"></div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>(); </div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints); </div><div class="line"></div><div class="line">  std::set&lt;types::boundary_id&gt; dirichlet_boundary_ids = {0}; </div><div class="line">  <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> homogeneous_dirichlet_bc; </div><div class="line">  <span class="keyword">const</span> std::map&lt;types::boundary_id, const Function&lt;dim&gt; *&gt; </div><div class="line">    dirichlet_boundary_functions = { </div><div class="line">      {<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>(0), &amp;homogeneous_dirichlet_bc}}; </div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler, </div><div class="line">                                           dirichlet_boundary_functions, </div><div class="line">                                           constraints); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">condense</a>(dsp); </div><div class="line">  sparsity_pattern.copy_from(dsp); </div><div class="line">  system_matrix.reinit(sparsity_pattern); </div></div><!-- fragment --><p>多网格约束必须被初始化。他们也需要知道边界值，所以我们也在这里传递 <code>dirichlet_boundary</code> 。</p>
<div class="fragment"><div class="line">mg_constrained_dofs.clear(); </div><div class="line">mg_constrained_dofs.initialize(dof_handler); </div><div class="line">mg_constrained_dofs.make_zero_boundary_constraints(dof_handler, </div><div class="line">                                                   dirichlet_boundary_ids); </div></div><!-- fragment --><p>现在是关于多网格数据结构的事情。首先，我们调整多级对象的大小，以容纳每一级的矩阵和稀疏模式。粗略的级别是零（现在是强制性的，但在未来的修订中可能会改变）。注意，这些函数在这里采取的是一个完整的、包容的范围（而不是一个起始索引和大小），所以最细的级别是 <code>n_levels-1</code> 。我们首先要调整容纳SparseMatrix类的容器的大小，因为它们必须在调整大小时释放它们的SparsityPattern才能被销毁。</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_levels = triangulation.n_levels(); </div><div class="line"></div><div class="line">mg_interface_in.resize(0, n_levels - 1); </div><div class="line">mg_interface_in.clear_elements(); </div><div class="line">mg_interface_out.resize(0, n_levels - 1); </div><div class="line">mg_interface_out.clear_elements(); </div><div class="line">mg_matrices.resize(0, n_levels - 1); </div><div class="line">mg_matrices.clear_elements(); </div><div class="line">mg_sparsity_patterns.resize(0, n_levels - 1); </div></div><!-- fragment --><p>现在，我们必须在每个层面上提供一个矩阵。为此，我们首先使用 <a class="el" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a> 函数在每个层次上生成一个初步的压缩稀疏模式（关于这个主题的更多信息，请参见 <a class="el" href="group__Sparsity.html">Sparsity patterns</a> 模块），然后把它复制到我们真正想要的那个层次上。下一步是用这些稀疏模式初始化两种层次矩阵。</p>
<p>值得指出的是，界面矩阵只有位于较粗的网格和较细的网格之间的界面上的自由度条目。因此，它们甚至比我们多网格层次结构中的各个层次的矩阵还要稀少。如果我们更关心内存的使用（可能还有我们使用这些矩阵的速度），我们应该对这两种矩阵使用不同的稀疏性模式。</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">    { </div><div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level), </div><div class="line">                                 dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level)); </div><div class="line">      <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line"></div><div class="line">      mg_sparsity_patterns[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].copy_from(dsp); </div><div class="line"></div><div class="line">      mg_matrices[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">      mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">      mg_interface_out[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemassemble_system"></a> </p><h4>LaplaceProblem::assemble_system</h4>
<p>下面的函数将线性系统装配在网格的最细层上。由于我们想在下面的层次装配中重用这里的代码，我们使用本地积分器类LaplaceIntegrator，而将循环留给MeshWorker框架。因此，这个函数首先设置了这个框架所需的对象，即</p>
<ul>
<li>一个 <a class="el" href="classMeshWorker_1_1IntegrationInfoBox.html">MeshWorker::IntegrationInfoBox</a> 对象，它将提供单元格上正交点的所有需要的数据。这个对象可以看作是FEValues的扩展，提供更多的有用信息。</li>
<li>一个 <a class="el" href="classMeshWorker_1_1DoFInfo.html">MeshWorker::DoFInfo</a> 对象，它一方面扩展了单元格迭代器的功能，另一方面也为其基类LocalResults的返回值提供了空间。</li>
<li>一个汇编器，在这里是指整个系统。这里的 "简单 "指的是全局系统没有一个块状结构。</li>
<li>本地集成器，它实现了实际的形式。</li>
</ul>
<p>在循环将所有这些组合成一个矩阵和一个右手边之后，还有一件事要做：集合器对受限自由度的矩阵行和列不做任何处理。因此，我们在对角线上放一个一，使整个系统摆好。一的值或任何固定的值都有一个好处，即它对矩阵的频谱的影响很容易理解。由于相应的特征向量形成了一个不变的子空间，所选择的值不会影响Krylov空间求解器的收敛性。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::assemble_system() </div><div class="line">{ </div><div class="line">  <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">  <a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html">MeshWorker::IntegrationInfoBox&lt;dim&gt;</a> info_box; </div><div class="line">  <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>                         update_flags = </div><div class="line">    <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a>; </div><div class="line">  info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#a7572e2216a5ce6a0f30b3df417dc90c6">add_update_flags_all</a>(update_flags); </div><div class="line">  info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#acb65243f284d15656e1bb6e2dbc2c607">initialize</a>(fe, mapping); </div><div class="line"></div><div class="line">  MeshWorker::DoFInfo&lt;dim&gt; dof_info(dof_handler); </div><div class="line"></div><div class="line">  <a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html">MeshWorker::Assembler::SystemSimple&lt;SparseMatrix&lt;double&gt;</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; </div><div class="line">    assembler; </div><div class="line">  assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html#abcc84b6bcef2300bcab47448c9289da7">initialize</a>(constraints); </div><div class="line">  assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html#abcc84b6bcef2300bcab47448c9289da7">initialize</a>(system_matrix, system_rhs); </div><div class="line"></div><div class="line">  LaplaceIntegrator&lt;dim&gt; matrix_integrator; </div><div class="line">  MeshWorker::integration_loop&lt;dim, dim&gt;(dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(), </div><div class="line">                                         dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>(), </div><div class="line">                                         dof_info, </div><div class="line">                                         info_box, </div><div class="line">                                         matrix_integrator, </div><div class="line">                                         assembler); </div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(); ++i) </div><div class="line">    <span class="keywordflow">if</span> (constraints.<a class="code" href="classAffineConstraints.html#a885d18f0044979873f5e5a6f33772f73">is_constrained</a>(i)) </div><div class="line">      system_matrix.set(i, i, 1.); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemassemble_multigrid"></a> </p><h4>LaplaceProblem::assemble_multigrid</h4>
<p>下一个函数是建立线性算子（矩阵），定义每一级网格上的多栅方法。积分的核心和上面的一样，但是下面的循环会遍历所有已有的单元，而不仅仅是活动的单元，而且结果必须输入正确的层次矩阵。幸运的是，MeshWorker对我们隐藏了大部分的内容，因此这个函数和之前的函数的区别只在于汇编器的设置和循环中不同的迭代器。另外，最后修复矩阵的过程也比较复杂。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::assemble_multigrid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">  <a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html">MeshWorker::IntegrationInfoBox&lt;dim&gt;</a> info_box; </div><div class="line">  <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>                         update_flags = </div><div class="line">    <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a>; </div><div class="line">  info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#a7572e2216a5ce6a0f30b3df417dc90c6">add_update_flags_all</a>(update_flags); </div><div class="line">  info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#acb65243f284d15656e1bb6e2dbc2c607">initialize</a>(fe, mapping); </div><div class="line"></div><div class="line">  MeshWorker::DoFInfo&lt;dim&gt; dof_info(dof_handler); </div><div class="line"></div><div class="line">  <a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html">MeshWorker::Assembler::MGMatrixSimple&lt;SparseMatrix&lt;double&gt;</a>&gt; assembler; </div><div class="line">  assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#aba020fe5832606b5a7ec4c3c54526adb">initialize</a>(mg_constrained_dofs); </div><div class="line">  assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#aba020fe5832606b5a7ec4c3c54526adb">initialize</a>(mg_matrices); </div><div class="line">  assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#a2509230e8e7076a818fb0e8a774dae40">initialize_interfaces</a>(mg_interface_in, mg_interface_out); </div><div class="line"></div><div class="line">  LaplaceIntegrator&lt;dim&gt; matrix_integrator; </div><div class="line">  MeshWorker::integration_loop&lt;dim, dim&gt;(dof_handler.<a class="code" href="classDoFHandler.html#a4f46e4221c995c41c925f8eef468b53c">begin_mg</a>(), </div><div class="line">                                         dof_handler.<a class="code" href="classDoFHandler.html#a70e36fc4bc2e6cfac62acb46c5f47db2">end_mg</a>(), </div><div class="line">                                         dof_info, </div><div class="line">                                         info_box, </div><div class="line">                                         matrix_integrator, </div><div class="line">                                         assembler); </div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nlevels = triangulation.n_levels(); </div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; nlevels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">    { </div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level); ++i) </div><div class="line">        <span class="keywordflow">if</span> (mg_constrained_dofs.is_boundary_index(level, i) || </div><div class="line">            mg_constrained_dofs.at_refinement_edge(level, i)) </div><div class="line">          mg_matrices[level].<span class="keyword">set</span>(i, i, 1.); </div><div class="line">    } </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemsolve"></a> </p><h4>LaplaceProblem::solve</h4>
<p>这是另外一个在支持多栅求解器（或者说，事实上，我们使用多栅方法的前提条件）方面有明显不同的函数。</p>
<p>让我们从建立多层次方法的两个组成部分开始：层次间的转移运算器和最粗层次上的求解器。在有限元方法中，转移算子来自所涉及的有限元函数空间，通常可以用独立于所考虑问题的通用方式计算。在这种情况下，我们可以使用MGTransferPrebuilt类，给定最终线性系统的约束和MGConstrainedDoFs对象，该对象知道每个层次的边界条件和不同细化层次之间接口的自由度，可以从具有层次自由度的DoFHandler对象中建立这些转移操作的矩阵。</p>
<p>下面几行的第二部分是关于粗略网格求解器的。由于我们的粗网格确实非常粗，我们决定采用直接求解器（最粗层次矩阵的Householder分解），即使其实现不是特别复杂。如果我们的粗网格比这里的5个单元多得多，那么这里显然需要更合适的东西。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::solve() </div><div class="line">{ </div><div class="line">  <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;Vector&lt;double&gt;</a>&gt; mg_transfer(mg_constrained_dofs); </div><div class="line">  mg_transfer.build(dof_handler); </div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> coarse_matrix; </div><div class="line">  coarse_matrix.<a class="code" href="classFullMatrix.html#ae9e8fbf00e15c7b66d527a5de4b31404">copy_from</a>(mg_matrices[0]); </div><div class="line">  <a class="code" href="classMGCoarseGridHouseholder.html">MGCoarseGridHouseholder&lt;double, Vector&lt;double&gt;</a>&gt; coarse_grid_solver; </div><div class="line">  coarse_grid_solver.<a class="code" href="classMGCoarseGridHouseholder.html#a07bd76dc7f6f66cb22d3e7951a558f50">initialize</a>(coarse_matrix); </div></div><!-- fragment --><p>多级求解器或预处理器的下一个组成部分是，我们需要在每一级上有一个平滑器。这方面常见的选择是使用松弛方法的应用（如SOR、Jacobi或Richardson方法）或求解器方法的少量迭代（如CG或GMRES）。 <a class="el" href="classmg_1_1SmootherRelaxation.html">mg::SmootherRelaxation</a> 和MGSmootherPrecondition类为这两种平滑器提供支持。这里，我们选择应用单一的SOR迭代。为此，我们定义一个适当的别名，然后设置一个平滑器对象。</p>
<p>最后一步是用我们的水平矩阵初始化平滑器对象，并设置一些平滑参数。 <code>initialize()</code> 函数可以有选择地接受额外的参数，这些参数将被传递给每一级的平滑器对象。在当前SOR平滑器的情况下，这可能包括一个松弛参数。然而，我们在这里将这些参数保留为默认值。对 <code>set_steps()</code> 的调用表明我们将在每个级别上使用两个前平滑步骤和两个后平滑步骤；为了在不同级别上使用可变数量的平滑器步骤，可以在对 <code>mg_smoother</code> 对象的构造函数调用中设置更多选项。</p>
<p>最后一步的结果是我们使用SOR方法作为平滑器的事实</p>
<p>&ndash;这不是对称的</p>
<p>但我们在下面使用共轭梯度迭代（需要对称的预处理），我们需要让多级预处理确保我们得到一个对称的算子，即使是非对称的平滑器。</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> Smoother = <a class="code" href="classPreconditionSOR.html">PreconditionSOR&lt;SparseMatrix&lt;double&gt;</a>&gt;; </div><div class="line"><a class="code" href="classmg_1_1SmootherRelaxation.html">mg::SmootherRelaxation&lt;Smoother, Vector&lt;double&gt;</a>&gt; mg_smoother; </div><div class="line">mg_smoother.<a class="code" href="classmg_1_1SmootherRelaxation.html#ae9e03c626c50a1b13dffe338f5f977b0">initialize</a>(mg_matrices); </div><div class="line">mg_smoother.<a class="code" href="classMGSmoother.html#a9976182b6b272aac7800a8fbf18c8ab9">set_steps</a>(2); </div><div class="line">mg_smoother.<a class="code" href="classMGSmoother.html#abed2837ee4e224f94c6a98405906df8f">set_symmetric</a>(<span class="keyword">true</span>); </div></div><!-- fragment --><p>下一个准备步骤是，我们必须将我们的水平矩阵和接口矩阵包裹在一个具有所需乘法函数的对象中。我们将为从粗到细的接口对象创建两个对象，反之亦然；多网格算法将在以后的操作中使用转置运算器，允许我们用已经建立的矩阵初始化该运算器的上下版本。</p>
<div class="fragment"><div class="line"><a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_matrix(mg_matrices); </div><div class="line"><a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_interface_up(mg_interface_in); </div><div class="line"><a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_interface_down(mg_interface_out); </div></div><!-- fragment --><p>现在，我们准备设置V型循环算子和多级预处理程序。</p>
<div class="fragment"><div class="line"><a class="code" href="classMultigrid.html">Multigrid&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">  mg_matrix, coarse_grid_solver, mg_transfer, mg_smoother, mg_smoother); </div><div class="line"><a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_interface_down, mg_interface_up); </div><div class="line"></div><div class="line"><a class="code" href="classPreconditionMG.html">PreconditionMG&lt;dim, Vector&lt;double&gt;</a>, <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;Vector&lt;double&gt;</a>&gt;&gt; </div><div class="line">  preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div></div><!-- fragment --><p>有了这一切，我们终于可以用通常的方法来解决这个线性系统了。</p>
<div class="fragment"><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12); </div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; solver(solver_control); </div><div class="line"></div><div class="line">  solution = 0; </div><div class="line"></div><div class="line">  solver.solve(system_matrix, solution, system_rhs, preconditioner); </div><div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="Postprocessing"></a> </p><h4>Postprocessing</h4>
<p>下面两个函数在计算出解决方案后对其进行后处理。特别是，第一个函数在每个周期开始时细化网格，第二个函数在每个周期结束时输出结果。这些函数与 <a class="el" href="step_6.html">step-6</a> 中的函数几乎没有变化，只有一个小的区别：我们以VTK格式生成输出，以使用当今更现代的可视化程序，而不是 <a class="el" href="step_6.html">step-6</a> 编写时的那些。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::refine_grid() </div><div class="line">{ </div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(triangulation.n_active_cells()); </div><div class="line"></div><div class="line">  <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>( </div><div class="line">    dof_handler, </div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1), </div><div class="line">    std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(), </div><div class="line">    solution, </div><div class="line">    estimated_error_per_cell); </div><div class="line">  <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(triangulation, </div><div class="line">                                                  estimated_error_per_cell, </div><div class="line">                                                  0.3, </div><div class="line">                                                  0.03); </div><div class="line">  triangulation.execute_coarsening_and_refinement(); </div><div class="line">} </div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line"><span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const </span></div><div class="line"><span class="keyword"></span>{ </div><div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out; </div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler); </div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>); </div><div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(); </div><div class="line"></div><div class="line">  std::ofstream output(<span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespacePatterns_1_1Tools.html#a72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(cycle) + <span class="stringliteral">&quot;.vtk&quot;</span>); </div><div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output); </div><div class="line">} </div></div><!-- fragment --><p><a class="anchor" id="LaplaceProblemrun"></a> </p><h4>LaplaceProblem::run</h4>
<p>和上面的几个函数一样，这几乎是对 <a class="el" href="step_6.html">step-6</a> 中相应函数的复制。唯一的区别是对 <code>assemble_multigrid</code> 的调用，它负责形成我们在多网格方法中需要的每一层的矩阵。</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">LaplaceProblem&lt;dim&gt;::run</a>() </div><div class="line">  { </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; 8; ++cycle) </div><div class="line">      { </div><div class="line">        <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; std::endl; </div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0) </div><div class="line">          { </div><div class="line">            <a class="code" href="namespaceGridGenerator.html#a533c4778cbc9bcbed365dcab42ca4418">GridGenerator::hyper_ball</a>(triangulation); </div><div class="line">            triangulation.refine_global(1); </div><div class="line">          } </div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">          refine_grid(); </div><div class="line"></div><div class="line">        <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span> </div><div class="line">                &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl; </div><div class="line"></div><div class="line">        setup_system(); </div><div class="line"></div><div class="line">        assemble_system(); </div><div class="line">        assemble_multigrid(); </div><div class="line"></div><div class="line">        solve(); </div><div class="line">        output_results(cycle); </div><div class="line">      } </div><div class="line">  } </div><div class="line">} <span class="comment">// namespace Step16 </span></div></div><!-- fragment --><p><a class="anchor" id="Themainfunction"></a> </p><h3>The main() function</h3>
<p>这又是与 <a class="el" href="step_6.html">step-6</a> 中相同的函数。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main() </div><div class="line">{ </div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      <span class="keyword">using namespace </span>Step16; </div><div class="line"></div><div class="line">      <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a>.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a>(2); </div><div class="line"></div><div class="line">      LaplaceProblem&lt;2&gt; laplace_problem(1); </div><div class="line">      laplace_problem.run(); </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (...) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0; </div><div class="line">} </div></div><!-- fragment --><p> examples/step-16b/doc/results.dox</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>如同第16步，在最细的网格上，解决方案看起来是这样的。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-16.solution.png"/>
</div>
 <p>。</p>
<p>与<a class="el" href="step_16.html">step-16</a>相比，输出的格式略有不同，但在功能上是一样的，显示了相同的收敛特性。</p>
<p>DEAL::Cycle 0 DEAL:: 活动单元数：20 DEAL:: 自由度数：25（通过级别：8，25） DEAL:cg::Starting 值 0.510691 DEAL:cg::Convergence 步骤6 值 4.59193e-14 DEAL::Cycle 1 DEAL:: 活动单元数：44 DEAL:: 自由度数：55（按级别：8，25，45） DEAL:cg::Starting 值 0.440678 DEAL:cg::Convergence 步骤8值 1.99419e-13 DEAL::Cycle 2 DEAL:: 活动单元数：86 DEAL:: 自由度数：105（按级别：8，25，69，49） DEAL:cg::Starting 值 0.371855 DEAL:cg::Convergence 步骤 9 值 1.13984e-13 DEAL::Cycle 3 DEAL:: 活动单元数：170 DEAL:: 自由度数：200（按级别：8，25，77，174） DEAL:cg::Starting 值 0.318967 DEAL:cg::Convergence 步骤 9 值 2.62112e-13 DEAL::Cycle 4 DEAL:: 活动单元数：332 DEAL:: 自由度数：388（按级别：8, 25, 86, 231, 204） DEAL:cg::Starting 值 0.276534 DEAL:cg::Convergence 步骤10值 1.69562e-13 DEAL::Cycle 5 DEAL:: 活动单元数：632 DEAL:: 自由度数：714（按级别：8, 25, 89, 231, 514, 141） DEAL:cg::Starting 值 0.215300 DEAL:cg::Convergence 步骤10值 6.47463e-13 DEAL::Cycle 6 DEAL:: 活动单元数：1202 DEAL:: 自由度数：1332（按级别：8, 25, 89, 282, 771, 435, 257） DEAL:cg::Starting 值 0.175848 DEAL:cg::Convergence 第10步值 1.80664e-13 DEAL::Cycle 7 DEAL:: 活动单元数：2288 DEAL:: 自由度数：2511（按级别：8、25、89、318、779、1420、829、30） DEAL:cg::Starting 值 0.136724 DEAL:cg::Convergence 第11步值 9.73331e-14 </p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* --------------------------------------------------------------------- </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * Copyright (C) 2003 - 2021 by the deal.II authors </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * This file is part of the deal.II library. </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute </span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General </span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either </span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version. </span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at </span></div><div class="line"><span class="comment"> * the top level directory of deal.II. </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * --------------------------------------------------------------------- </span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * Authors: Guido Kanschat, University of Heidelberg, 2003 </span></div><div class="line"><span class="comment"> *          Baerbel Janssen, University of Heidelberg, 2010 </span></div><div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University, 2010 </span></div><div class="line"><span class="comment"> */</span> </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span> </div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__constrained__dofs_8h.html">deal.II/multigrid/mg_constrained_dofs.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="multigrid_8h.html">deal.II/multigrid/multigrid.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__transfer_8h.html">deal.II/multigrid/mg_transfer.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__tools_8h.html">deal.II/multigrid/mg_tools.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__coarse_8h.html">deal.II/multigrid/mg_coarse.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__smoother_8h.html">deal.II/multigrid/mg_smoother.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mg__matrix_8h.html">deal.II/multigrid/mg_matrix.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="meshworker_2dof__info_8h.html">deal.II/meshworker/dof_info.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="integration__info_8h.html">deal.II/meshworker/integration_info.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="simple_8h.html">deal.II/meshworker/simple.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="output_8h.html">deal.II/meshworker/output.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="loop_8h.html">deal.II/meshworker/loop.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="laplace_8h.html">deal.II/integrators/laplace.h</a>&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="l2_8h.html">deal.II/integrators/l2.h</a>&gt;</span> </div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span> </div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span> </div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>; </div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step16 </div><div class="line">{ </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keyword">class </span>LaplaceIntegrator : <span class="keyword">public</span> <a class="code" href="classMeshWorker_1_1LocalIntegrator.html">MeshWorker::LocalIntegrator</a>&lt;dim&gt; </div><div class="line">  { </div><div class="line">  <span class="keyword">public</span>: </div><div class="line">    LaplaceIntegrator(); </div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> cell(MeshWorker::DoFInfo&lt;dim&gt; &amp;        dinfo, </div><div class="line">                      <a class="code" href="classMeshWorker_1_1IntegrationInfo.html">MeshWorker::IntegrationInfo&lt;dim&gt;</a> &amp;info) <span class="keyword">const override</span>; </div><div class="line">  }; </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  LaplaceIntegrator&lt;dim&gt;::LaplaceIntegrator() </div><div class="line">    : <a class="code" href="namespaceMeshWorker.html">MeshWorker</a>::LocalIntegrator&lt;dim&gt;(true, false, false) </div><div class="line">  {} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> </div><div class="line">  LaplaceIntegrator&lt;dim&gt;::cell(MeshWorker::DoFInfo&lt;dim&gt; &amp;        dinfo, </div><div class="line">                               <a class="code" href="classMeshWorker_1_1IntegrationInfo.html">MeshWorker::IntegrationInfo&lt;dim&gt;</a> &amp;info)<span class="keyword"> const </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#ac63bee72524d6f8c064b23e3ccb576af">n_matrices</a>(), 1); </div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> coefficient = (dinfo.<a class="code" href="classMeshWorker_1_1DoFInfo.html#acdb25148428f90647ca6c6166e212ffa">cell</a>-&gt;center()(0) &gt; 0.) ? .1 : 1.; </div><div class="line"></div><div class="line">    <a class="code" href="namespaceLocalIntegrators_1_1Laplace.html#a733b581e72bfe9d27cc59501a35bcd30">LocalIntegrators::Laplace::cell_matrix</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a06c5d817ce47a4c26966df1cdcebeac4">matrix</a>(0, <span class="keyword">false</span>).matrix, </div><div class="line">                                           info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0), </div><div class="line">                                           coefficient); </div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a18a21989c69233694473c643d44df24f">n_vectors</a>() &gt; 0) </div><div class="line">      { </div><div class="line">        std::vector&lt;double&gt; rhs(info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0).n_quadrature_points, 1.); </div><div class="line">        <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">LocalIntegrators::L2::L2</a>(dinfo.<a class="code" href="classMeshWorker_1_1LocalResults.html#a13d325f993aa366ce5f837f37d96a90b">vector</a>(0).block(0), </div><div class="line">                                 info.<a class="code" href="classMeshWorker_1_1IntegrationInfo.html#a32fa7363be71ba320bcdc94f6d677843">fe_values</a>(0), </div><div class="line">                                 rhs); </div><div class="line">      } </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keyword">class </span>LaplaceProblem </div><div class="line">  { </div><div class="line">  <span class="keyword">public</span>: </div><div class="line">    LaplaceProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree); </div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>(); </div><div class="line"></div><div class="line">  <span class="keyword">private</span>: </div><div class="line">    <span class="keywordtype">void</span> setup_system(); </div><div class="line">    <span class="keywordtype">void</span> assemble_system(); </div><div class="line">    <span class="keywordtype">void</span> assemble_multigrid(); </div><div class="line">    <span class="keywordtype">void</span> solve(); </div><div class="line">    <span class="keywordtype">void</span> refine_grid(); </div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>; </div><div class="line"></div><div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>; </div><div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe; </div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler; </div><div class="line"></div><div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern; </div><div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix; </div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints; </div><div class="line"></div><div class="line">    Vector&lt;double&gt; solution; </div><div class="line">    Vector&lt;double&gt; system_rhs; </div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree; </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparsityPattern&gt;</a>      mg_sparsity_patterns; </div><div class="line">    <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_matrices; </div><div class="line">    <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_interface_in; </div><div class="line">    <a class="code" href="classMGLevelObject.html">MGLevelObject&lt;SparseMatrix&lt;double&gt;</a>&gt; mg_interface_out; </div><div class="line">    <a class="code" href="classMGConstrainedDoFs.html">MGConstrainedDoFs</a>                   mg_constrained_dofs; </div><div class="line">  }; </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  LaplaceProblem&lt;dim&gt;::LaplaceProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree) </div><div class="line">    : triangulation(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::limit_level_difference_at_vertices) </div><div class="line">    , fe(degree) </div><div class="line">    , dof_handler(triangulation) </div><div class="line">    , degree(degree) </div><div class="line">  {} </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::setup_system() </div><div class="line">  { </div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe); </div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a9aed31323cbd7619edac310c47e7a7ad">distribute_mg_dofs</a>(); </div><div class="line"></div><div class="line">    <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() </div><div class="line">            &lt;&lt; <span class="stringliteral">&quot; (by level: &quot;</span>; </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; triangulation.n_levels(); ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">      <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level) </div><div class="line">              &lt;&lt; (level == triangulation.n_levels() - 1 ? <span class="stringliteral">&quot;)&quot;</span> : <span class="stringliteral">&quot;, &quot;</span>); </div><div class="line">    <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; std::endl; </div><div class="line"></div><div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(), dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp); </div><div class="line"></div><div class="line">    solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()); </div><div class="line"></div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>(); </div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints); </div><div class="line"></div><div class="line">    std::set&lt;types::boundary_id&gt; dirichlet_boundary_ids = {0}; </div><div class="line">    <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> homogeneous_dirichlet_bc; </div><div class="line">    <span class="keyword">const</span> std::map&lt;types::boundary_id, const Function&lt;dim&gt; *&gt; </div><div class="line">      dirichlet_boundary_functions = { </div><div class="line">        {<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>(0), &amp;homogeneous_dirichlet_bc}}; </div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler, </div><div class="line">                                             dirichlet_boundary_functions, </div><div class="line">                                             constraints); </div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>(); </div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">condense</a>(dsp); </div><div class="line">    sparsity_pattern.copy_from(dsp); </div><div class="line">    system_matrix.reinit(sparsity_pattern); </div><div class="line"></div><div class="line"></div><div class="line">    mg_constrained_dofs.clear(); </div><div class="line">    mg_constrained_dofs.initialize(dof_handler); </div><div class="line">    mg_constrained_dofs.make_zero_boundary_constraints(dof_handler, </div><div class="line">                                                       dirichlet_boundary_ids); </div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_levels = triangulation.n_levels(); </div><div class="line"></div><div class="line">    mg_interface_in.resize(0, n_levels - 1); </div><div class="line">    mg_interface_in.clear_elements(); </div><div class="line">    mg_interface_out.resize(0, n_levels - 1); </div><div class="line">    mg_interface_out.clear_elements(); </div><div class="line">    mg_matrices.resize(0, n_levels - 1); </div><div class="line">    mg_matrices.clear_elements(); </div><div class="line">    mg_sparsity_patterns.resize(0, n_levels - 1); </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; n_levels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">      { </div><div class="line">        <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level), </div><div class="line">                                   dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level)); </div><div class="line">        <a class="code" href="namespaceMGTools.html#a19ba9ee4a2b65235c8bb3fb65ea8f4e0">MGTools::make_sparsity_pattern</a>(dof_handler, dsp, level); </div><div class="line"></div><div class="line">        mg_sparsity_patterns[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].copy_from(dsp); </div><div class="line"></div><div class="line">        mg_matrices[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">        mg_interface_in[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">        mg_interface_out[<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>].reinit(mg_sparsity_patterns[level]); </div><div class="line">      } </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::assemble_system() </div><div class="line">  { </div><div class="line">    <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">    <a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html">MeshWorker::IntegrationInfoBox&lt;dim&gt;</a> info_box; </div><div class="line">    <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>                         update_flags = </div><div class="line">      <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a>; </div><div class="line">    info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#a7572e2216a5ce6a0f30b3df417dc90c6">add_update_flags_all</a>(update_flags); </div><div class="line">    info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#acb65243f284d15656e1bb6e2dbc2c607">initialize</a>(fe, mapping); </div><div class="line"></div><div class="line">    MeshWorker::DoFInfo&lt;dim&gt; dof_info(dof_handler); </div><div class="line"></div><div class="line">    <a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html">MeshWorker::Assembler::SystemSimple&lt;SparseMatrix&lt;double&gt;</a>, Vector&lt;double&gt;&gt; </div><div class="line">      assembler; </div><div class="line">    assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html#abcc84b6bcef2300bcab47448c9289da7">initialize</a>(constraints); </div><div class="line">    assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1SystemSimple.html#abcc84b6bcef2300bcab47448c9289da7">initialize</a>(system_matrix, system_rhs); </div><div class="line"></div><div class="line">    LaplaceIntegrator&lt;dim&gt; matrix_integrator; </div><div class="line">    MeshWorker::integration_loop&lt;dim, dim&gt;(dof_handler.<a class="code" href="classDoFHandler.html#a1a36dbbb4c54a7038c60ee9c8eab369a">begin_active</a>(), </div><div class="line">                                           dof_handler.<a class="code" href="classDoFHandler.html#a7b510a66ee9ea25720f64220496126ec">end</a>(), </div><div class="line">                                           dof_info, </div><div class="line">                                           info_box, </div><div class="line">                                           matrix_integrator, </div><div class="line">                                           assembler); </div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(); ++i) </div><div class="line">      <span class="keywordflow">if</span> (constraints.<a class="code" href="classAffineConstraints.html#a885d18f0044979873f5e5a6f33772f73">is_constrained</a>(i)) </div><div class="line">        system_matrix.set(i, i, 1.); </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::assemble_multigrid() </div><div class="line">  { </div><div class="line">    <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a>                      mapping; </div><div class="line">    <a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html">MeshWorker::IntegrationInfoBox&lt;dim&gt;</a> info_box; </div><div class="line">    <a class="code" href="group__feaccess.html#gaa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>                         update_flags = </div><div class="line">      <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a>; </div><div class="line">    info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#a7572e2216a5ce6a0f30b3df417dc90c6">add_update_flags_all</a>(update_flags); </div><div class="line">    info_box.<a class="code" href="classMeshWorker_1_1IntegrationInfoBox.html#acb65243f284d15656e1bb6e2dbc2c607">initialize</a>(fe, mapping); </div><div class="line"></div><div class="line">    MeshWorker::DoFInfo&lt;dim&gt; dof_info(dof_handler); </div><div class="line"></div><div class="line">    <a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html">MeshWorker::Assembler::MGMatrixSimple&lt;SparseMatrix&lt;double&gt;</a>&gt; assembler; </div><div class="line">    assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#aba020fe5832606b5a7ec4c3c54526adb">initialize</a>(mg_constrained_dofs); </div><div class="line">    assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#aba020fe5832606b5a7ec4c3c54526adb">initialize</a>(mg_matrices); </div><div class="line">    assembler.<a class="code" href="classMeshWorker_1_1Assembler_1_1MGMatrixSimple.html#a2509230e8e7076a818fb0e8a774dae40">initialize_interfaces</a>(mg_interface_in, mg_interface_out); </div><div class="line"></div><div class="line">    LaplaceIntegrator&lt;dim&gt; matrix_integrator; </div><div class="line">    MeshWorker::integration_loop&lt;dim, dim&gt;(dof_handler.<a class="code" href="classDoFHandler.html#a4f46e4221c995c41c925f8eef468b53c">begin_mg</a>(), </div><div class="line">                                           dof_handler.<a class="code" href="classDoFHandler.html#a70e36fc4bc2e6cfac62acb46c5f47db2">end_mg</a>(), </div><div class="line">                                           dof_info, </div><div class="line">                                           info_box, </div><div class="line">                                           matrix_integrator, </div><div class="line">                                           assembler); </div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nlevels = triangulation.n_levels(); </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = 0; level &lt; nlevels; ++<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>) </div><div class="line">      { </div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>(level); ++i) </div><div class="line">          <span class="keywordflow">if</span> (mg_constrained_dofs.is_boundary_index(level, i) || </div><div class="line">              mg_constrained_dofs.at_refinement_edge(level, i)) </div><div class="line">            mg_matrices[level].<span class="keyword">set</span>(i, i, 1.); </div><div class="line">      } </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::solve() </div><div class="line">  { </div><div class="line">    <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;Vector&lt;double&gt;</a>&gt; mg_transfer(mg_constrained_dofs); </div><div class="line">    mg_transfer.build(dof_handler); </div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> coarse_matrix; </div><div class="line">    coarse_matrix.<a class="code" href="classFullMatrix.html#ae9e8fbf00e15c7b66d527a5de4b31404">copy_from</a>(mg_matrices[0]); </div><div class="line">    <a class="code" href="classMGCoarseGridHouseholder.html">MGCoarseGridHouseholder&lt;double, Vector&lt;double&gt;</a>&gt; coarse_grid_solver; </div><div class="line">    coarse_grid_solver.<a class="code" href="classMGCoarseGridHouseholder.html#a07bd76dc7f6f66cb22d3e7951a558f50">initialize</a>(coarse_matrix); </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">using</span> Smoother = <a class="code" href="classPreconditionSOR.html">PreconditionSOR&lt;SparseMatrix&lt;double&gt;</a>&gt;; </div><div class="line">    <a class="code" href="classmg_1_1SmootherRelaxation.html">mg::SmootherRelaxation&lt;Smoother, Vector&lt;double&gt;</a>&gt; mg_smoother; </div><div class="line">    mg_smoother.<a class="code" href="classmg_1_1SmootherRelaxation.html#ae9e03c626c50a1b13dffe338f5f977b0">initialize</a>(mg_matrices); </div><div class="line">    mg_smoother.<a class="code" href="classMGSmoother.html#a9976182b6b272aac7800a8fbf18c8ab9">set_steps</a>(2); </div><div class="line">    mg_smoother.<a class="code" href="classMGSmoother.html#abed2837ee4e224f94c6a98405906df8f">set_symmetric</a>(<span class="keyword">true</span>); </div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_matrix(mg_matrices); </div><div class="line">    <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_interface_up(mg_interface_in); </div><div class="line">    <a class="code" href="classmg_1_1Matrix.html">mg::Matrix&lt;Vector&lt;double&gt;</a>&gt; mg_interface_down(mg_interface_out); </div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classMultigrid.html">Multigrid&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="namespacemg.html">mg</a>( </div><div class="line">      mg_matrix, coarse_grid_solver, mg_transfer, mg_smoother, mg_smoother); </div><div class="line">    <a class="code" href="namespacemg.html">mg</a>.set_edge_matrices(mg_interface_down, mg_interface_up); </div><div class="line"></div><div class="line">    <a class="code" href="classPreconditionMG.html">PreconditionMG&lt;dim, Vector&lt;double&gt;</a>, <a class="code" href="classMGTransferPrebuilt.html">MGTransferPrebuilt&lt;Vector&lt;double&gt;</a>&gt;&gt; </div><div class="line">      preconditioner(dof_handler, <a class="code" href="namespacemg.html">mg</a>, mg_transfer); </div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12); </div><div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; solver(solver_control); </div><div class="line"></div><div class="line">    solution = 0; </div><div class="line"></div><div class="line">    solver.solve(system_matrix, solution, system_rhs, preconditioner); </div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(solution); </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::refine_grid() </div><div class="line">  { </div><div class="line">    Vector&lt;float&gt; estimated_error_per_cell(triangulation.n_active_cells()); </div><div class="line"></div><div class="line">    <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>( </div><div class="line">      dof_handler, </div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1), </div><div class="line">      std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(), </div><div class="line">      solution, </div><div class="line">      estimated_error_per_cell); </div><div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(triangulation, </div><div class="line">                                                    estimated_error_per_cell, </div><div class="line">                                                    0.3, </div><div class="line">                                                    0.03); </div><div class="line">    triangulation.execute_coarsening_and_refinement(); </div><div class="line">  } </div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> LaplaceProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const </span></div><div class="line"><span class="keyword">  </span>{ </div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out; </div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler); </div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>); </div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(); </div><div class="line"></div><div class="line">    std::ofstream output(<span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespacePatterns_1_1Tools.html#a72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(cycle) + <span class="stringliteral">&quot;.vtk&quot;</span>); </div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output); </div><div class="line">  } </div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt; </div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">LaplaceProblem&lt;dim&gt;::run</a>() </div><div class="line">  { </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; 8; ++cycle) </div><div class="line">      { </div><div class="line">        <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; std::endl; </div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0) </div><div class="line">          { </div><div class="line">            <a class="code" href="namespaceGridGenerator.html#a533c4778cbc9bcbed365dcab42ca4418">GridGenerator::hyper_ball</a>(triangulation); </div><div class="line">            triangulation.refine_global(1); </div><div class="line">          } </div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">          refine_grid(); </div><div class="line"></div><div class="line">        <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a> &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span> </div><div class="line">                &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl; </div><div class="line"></div><div class="line">        setup_system(); </div><div class="line"></div><div class="line">        assemble_system(); </div><div class="line">        assemble_multigrid(); </div><div class="line"></div><div class="line">        solve(); </div><div class="line">        output_results(cycle); </div><div class="line">      } </div><div class="line">  } </div><div class="line">} <span class="comment">// namespace Step16 </span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() </div><div class="line">{ </div><div class="line">  <span class="keywordflow">try</span> </div><div class="line">    { </div><div class="line">      <span class="keyword">using namespace </span>Step16; </div><div class="line"></div><div class="line">      <a class="code" href="logstream_8h.html#ac643e79bd992f1a9bd0dca5b9f2859fb">deallog</a>.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a>(2); </div><div class="line"></div><div class="line">      LaplaceProblem&lt;2&gt; laplace_problem(1); </div><div class="line">      laplace_problem.run(); </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line">  <span class="keywordflow">catch</span> (...) </div><div class="line">    { </div><div class="line">      std::cerr &lt;&lt; std::endl </div><div class="line">                &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl </div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span> </div><div class="line">                &lt;&lt; std::endl; </div><div class="line">      <span class="keywordflow">return</span> 1; </div><div class="line">    } </div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0; </div><div class="line">} </div><div class="line"></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
